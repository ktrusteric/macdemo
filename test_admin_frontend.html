<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜ä»ªè¡¨æ¿æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        .login-section, .stats-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç®¡ç†å‘˜ä»ªè¡¨æ¿æµ‹è¯•</h1>
        
        <!-- ç™»å½•éƒ¨åˆ† -->
        <div class="login-section">
            <h2>ç®¡ç†å‘˜ç™»å½•</h2>
            <input type="text" id="username" placeholder="ç”¨æˆ·å" value="superadmin">
            <input type="password" id="password" placeholder="å¯†ç " value="super123456">
            <button onclick="adminLogin()">ç™»å½•</button>
            <button onclick="logout()">ç™»å‡º</button>
            <div id="loginStatus"></div>
        </div>
        
        <!-- ç»Ÿè®¡æ•°æ®éƒ¨åˆ† -->
        <div class="stats-section">
            <h2>ç»Ÿè®¡æ•°æ®</h2>
            <button onclick="loadStats()" id="loadStatsBtn">åŠ è½½ç»Ÿè®¡æ•°æ®</button>
            <button onclick="testFrontendLogic()">æµ‹è¯•å‰ç«¯é€»è¾‘</button>
            
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalArticles">-</div>
                    <div class="stat-label">æ€»æ–‡ç« æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="adminUsers">-</div>
                    <div class="stat-label">ç®¡ç†å‘˜æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="regularUsers">-</div>
                    <div class="stat-label">æ™®é€šç”¨æˆ·</div>
                </div>
            </div>
            
            <h3>æ–‡ç« ç±»å‹åˆ†å¸ƒ</h3>
            <div id="typeDistribution"></div>
        </div>
        
        <!-- æ—¥å¿—éƒ¨åˆ† -->
        <div class="login-section">
            <h2>æµ‹è¯•æ—¥å¿—</h2>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <script>
        let adminToken = null;
        let currentStats = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('testLog');
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        function showStatus(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
        }
        
        async function adminLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            log(`å°è¯•ç®¡ç†å‘˜ç™»å½•: ${username}`);
            
            try {
                const response = await fetch('/api/v1/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    adminToken = result.access_token;
                    log(`âœ… ç™»å½•æˆåŠŸ: ${result.admin.username}`, 'success');
                    showStatus('loginStatus', `ç™»å½•æˆåŠŸ: ${result.admin.username}`);
                    document.getElementById('loadStatsBtn').disabled = false;
                } else {
                    const error = await response.json();
                    log(`âŒ ç™»å½•å¤±è´¥: ${error.detail}`, 'error');
                    showStatus('loginStatus', `ç™»å½•å¤±è´¥: ${error.detail}`, true);
                }
            } catch (error) {
                log(`âŒ ç™»å½•å¼‚å¸¸: ${error.message}`, 'error');
                showStatus('loginStatus', `ç™»å½•å¼‚å¸¸: ${error.message}`, true);
            }
        }
        
        function logout() {
            adminToken = null;
            currentStats = null;
            log('å·²ç™»å‡º');
            showStatus('loginStatus', 'å·²ç™»å‡º');
            document.getElementById('loadStatsBtn').disabled = true;
            
            // æ¸…ç©ºç»Ÿè®¡æ•°æ®æ˜¾ç¤º
            document.getElementById('totalArticles').textContent = '-';
            document.getElementById('totalUsers').textContent = '-';
            document.getElementById('adminUsers').textContent = '-';
            document.getElementById('regularUsers').textContent = '-';
            document.getElementById('typeDistribution').innerHTML = '';
        }
        
        async function loadStats() {
            if (!adminToken) {
                log('âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            log('åŠ è½½ç»Ÿè®¡æ•°æ®...');
            
            try {
                const response = await fetch('/api/v1/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                if (response.ok) {
                    currentStats = await response.json();
                    log('âœ… ç»Ÿè®¡æ•°æ®åŠ è½½æˆåŠŸ', 'success');
                    log(`åŸå§‹æ•°æ®: ${JSON.stringify(currentStats, null, 2)}`);
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateStatsDisplay(currentStats);
                } else {
                    const error = await response.json();
                    log(`âŒ åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ${error.detail}`, 'error');
                }
            } catch (error) {
                log(`âŒ åŠ è½½ç»Ÿè®¡æ•°æ®å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        function updateStatsDisplay(stats) {
            // æ¨¡æ‹Ÿå‰ç«¯è®¡ç®—é€»è¾‘
            const totalArticles = stats?.articles?.total || 0;
            const totalUsers = stats?.users?.total || 0;
            const adminUsers = stats?.users?.admins || 0;
            const regularUsers = stats?.users?.regular || 0;
            const typeDistribution = stats?.articles?.by_type || {};
            
            log(`è®¡ç®—ç»“æœ: æ–‡ç« æ€»æ•°=${totalArticles}, ç”¨æˆ·æ€»æ•°=${totalUsers}`);
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalArticles').textContent = totalArticles;
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('adminUsers').textContent = adminUsers;
            document.getElementById('regularUsers').textContent = regularUsers;
            
            // æ˜¾ç¤ºæ–‡ç« ç±»å‹åˆ†å¸ƒ
            const typeDiv = document.getElementById('typeDistribution');
            typeDiv.innerHTML = '';
            for (const [type, count] of Object.entries(typeDistribution)) {
                const typeMap = {
                    'policy': 'æ”¿ç­–æ³•è§„',
                    'news': 'è¡Œä¸šèµ„è®¯',
                    'price': 'è°ƒä»·å…¬å‘Š',
                    'announcement': 'äº¤æ˜“å…¬å‘Š'
                };
                const displayName = typeMap[type] || type;
                typeDiv.innerHTML += `<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 4px;">${displayName}: ${count}</div>`;
            }
        }
        
        function testFrontendLogic() {
            if (!currentStats) {
                log('âŒ è¯·å…ˆåŠ è½½ç»Ÿè®¡æ•°æ®', 'error');
                return;
            }
            
            log('æµ‹è¯•å‰ç«¯è®¡ç®—é€»è¾‘...');
            
            // æµ‹è¯•Vue.js computedå±æ€§é€»è¾‘
            const totalArticles = currentStats?.articles?.total || 0;
            const typeDistribution = currentStats?.articles?.by_type || {};
            
            log(`Vue computed æ¨¡æ‹Ÿ:`);
            log(`  totalArticles = stats.value?.articles?.total || 0 = ${totalArticles}`);
            log(`  typeDistribution = stats.value?.articles?.by_type || {} = ${JSON.stringify(typeDistribution)}`);
            
            // éªŒè¯è®¡ç®—
            const calculatedTotal = Object.values(typeDistribution).reduce((sum, count) => sum + count, 0);
            
            if (totalArticles === calculatedTotal) {
                log(`âœ… è®¡ç®—æ­£ç¡®: APIæ€»æ•°(${totalArticles}) = ç±»å‹ç»Ÿè®¡æ€»å’Œ(${calculatedTotal})`, 'success');
            } else {
                log(`âŒ è®¡ç®—é”™è¯¯: APIæ€»æ•°(${totalArticles}) â‰  ç±»å‹ç»Ÿè®¡æ€»å’Œ(${calculatedTotal})`, 'error');
            }
            
            if (totalArticles > 0) {
                log(`âœ… å‰ç«¯åº”è¯¥æ˜¾ç¤º: ${totalArticles}`, 'success');
            } else {
                log(`âŒ å‰ç«¯æ˜¾ç¤ºé—®é¢˜: æ˜¾ç¤ºä¸º0`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            document.getElementById('loadStatsBtn').disabled = true;
        });
    </script>
</body>
</html> 