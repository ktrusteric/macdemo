<template>
  <div class="dashboard-container">
    <!-- È°µÈù¢Â§¥ÈÉ® -->
    <div class="header-section">
      <h1 class="page-title">
        <el-icon class="title-icon"><Setting /></el-icon>
        ‰∏™‰∫∫ËÆæÁΩÆ
      </h1>
      <p class="page-subtitle">ÈÖçÁΩÆÊÇ®ÁöÑ‰∏™‰∫∫ÂÅèÂ•ΩËÆæÁΩÆ</p>
    </div>

    <!-- ËÆæÁΩÆÈÄâÈ°πÂç° -->
    <el-card class="settings-card">
      <el-tabs v-model="activeSettingTab" type="border-card" class="settings-tabs">
        <!-- Ê†áÁ≠æËÆæÁΩÆ -->
        <el-tab-pane label="Ê†áÁ≠æËÆæÁΩÆ" name="tags">
          <div class="settings-content">
            <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
            <div v-if="loading && !tags.length" class="loading-container">
              <el-skeleton animated>
                <template #template>
                  <el-skeleton-item variant="h1" />
                  <el-skeleton-item variant="text" />
                  <el-skeleton-item variant="text" />
                </template>
              </el-skeleton>
            </div>

            <!-- ÈîôËØØÊèêÁ§∫ -->
            <el-alert 
              v-if="error" 
              :title="error" 
              type="error" 
              show-icon 
              class="error-alert"
              @close="error = ''"
            />

            <!-- ÁªüËÆ°Ê¶ÇËßà -->
            <el-row :gutter="20" class="stats-section" v-if="!loading">
              <el-col :span="6">
                <el-card class="stat-card">
                  <el-statistic title="Ê†áÁ≠æÊÄªÊï∞" :value="totalTagsCount" />
                  <div class="stat-icon">üè∑Ô∏è</div>
                </el-card>
              </el-col>
              <el-col :span="6">
                <el-card class="stat-card">
                  <el-statistic title="ÂêØÁî®ÂàÜÁ±ª" :value="activeCategoriesCount" />
                  <div class="stat-icon">üìÇ</div>
                </el-card>
              </el-col>
              <el-col :span="6">
                <el-card class="stat-card">
                  <el-statistic title="ÊÄªÊùÉÈáç" :value="totalWeight" :precision="1" />
                  <div class="stat-icon">‚öñÔ∏è</div>
                </el-card>
              </el-col>
              <el-col :span="6">
                <el-card class="stat-card">
                  <el-statistic title="ÊúÄÂêéÊõ¥Êñ∞" :value="lastUpdateTime" />
                  <div class="stat-icon">üîÑ</div>
                </el-card>
              </el-col>
            </el-row>

            <!-- Ê†áÁ≠æÈ¢ÑËßà -->
            <el-card class="preview-card" v-if="tags.length">
              <template #header>
                <div class="preview-header">
                  <span class="preview-title">ÊàëÁöÑÊ†áÁ≠æ</span>
                  <div class="action-buttons">
                    <el-tooltip content="‰ªéÊúçÂä°Âô®ÈáçÊñ∞Âä†ËΩΩÊÇ®ÁöÑÊ†áÁ≠æÊï∞ÊçÆ" placement="top">
                      <el-button 
                        type="primary" 
                        @click="fetchTags" 
                        :loading="loading"
                      >
                        <el-icon><Refresh /></el-icon>
                        Âà∑Êñ∞Ê†áÁ≠æ
                      </el-button>
                    </el-tooltip>
                    <el-tooltip content="Â∞ÜÂΩìÂâç‰øÆÊîπ‰øùÂ≠òÂà∞ÊúçÂä°Âô®" placement="top">
                      <el-button 
                        type="success" 
                        @click="saveUserTags" 
                        :loading="saving"
                        :disabled="!hasChanges"
                      >
                        <el-icon><Check /></el-icon>
                        ‰øùÂ≠òÊõ¥Êîπ
                      </el-button>
                    </el-tooltip>
                    <el-tooltip content="‰øùÁïôÊ≥®ÂÜåÂú∞„ÄÅÁúÅ‰ªΩ„ÄÅÂå∫ÂüüÂíåËÉΩÊ∫ê‰∫ßÂìÅÊ†áÁ≠æÔºåÊ∏ÖÁêÜÂÖ∂‰ªñÊ†áÁ≠æ" placement="top">
                      <el-button 
                        type="warning"
                        @click="resetToDefaults"
                      >
                        <el-icon><RefreshLeft /></el-icon>
                        ÈáçÁΩÆÊ†áÁ≠æ
                      </el-button>
                    </el-tooltip>
                    <el-tooltip content="ÁßªÈô§ÈáçÂ§çÁöÑÊ†áÁ≠æÔºå‰øùÊåÅÊï∞ÊçÆÊï¥Ê¥Å" placement="top">
                      <el-button 
                        type="info"
                        @click="cleanDuplicates"
                      >
                        <el-icon><Delete /></el-icon>
                        Ê∏ÖÁêÜÈáçÂ§ç
                      </el-button>
                    </el-tooltip>
                  </div>
                </div>
              </template>
              <div class="preview-content">
                <div class="all-tags-cloud">
                  <el-tag
                    v-for="tag in sortedTagsForPreview"
                    :key="`preview-${tag.category}-${tag.name}`"
                    :type="getTagTypeByCategory(tag.category)"
                    :effect="tag.source === 'preset' ? 'dark' : 'plain'"
                    class="preview-tag"
                  >
                    {{ tag.name }}
                  </el-tag>
                </div>
              </div>
            </el-card>

            <!-- Ê†áÁ≠æÂàÜÁ±ªÁÆ°ÁêÜ -->
            <el-card class="tags-card">
              <template #header>
                <div class="tags-header">
                  <span class="tags-title">Ê†áÁ≠æÂàÜÁ±ªÁÆ°ÁêÜ</span>
                </div>
              </template>

              <el-tabs v-model="activeTab" type="border-card" class="tags-tabs">
                <el-tab-pane 
                  v-for="category in tagCategories" 
                  :key="category.key" 
                  :name="category.key"
                >
                  <template #label>
                    <div class="tab-label">
                      <span>{{ category.name }}</span>
                      <el-badge 
                        :value="getTagsByCategory(category.key).length" 
                        :type="getBadgeType(category.key)"
                        :hidden="getTagsByCategory(category.key).length === 0"
                      />
                    </div>
                  </template>

                  <div class="tab-content">
                    <!-- ÂàÜÁ±ªÊèèËø∞ -->
                    <div class="category-description">
                      <el-icon class="desc-icon"><InfoFilled /></el-icon>
                      <span>{{ category.description }}</span>
                    </div>

                    <!-- ÂΩìÂâçÊ†áÁ≠æ -->
                    <div class="current-tags-section">
                      <h4 class="section-title">ÂΩìÂâçÊ†áÁ≠æ</h4>
                      <div class="tags-container" v-if="getTagsByCategory(category.key).length">
                        <div
                          v-for="tag in getTagsByCategory(category.key)"
                          :key="`${tag.category}-${tag.name}`"
                          class="tag-item-wrapper"
                        >
                          <!-- Êñ∞ÁöÑÊ†áÁ≠æÊòæÁ§∫ÂåÖË£ÖÂô® -->
                          <div v-if="!tag.isEditing" class="tag-display-wrapper">
                            <el-tag
                              :type="getTagTypeByCategory(category.key)"
                              :effect="tag.source === 'preset' ? 'dark' : 'plain'"
                              class="tag-item-display"
                              @click="startEditWeight(tag)"
                            >
                              <div class="tag-content">
                                <span class="tag-name">{{ tag.name }}</span>
                                <span class="tag-weight">{{ tag.weight }}x</span>
                              </div>
                            </el-tag>
                            <div class="tag-actions">
                              <el-icon class="edit-icon" @click.stop="startEditWeight(tag)" title="ÁÇπÂáªÁºñËæëÊùÉÈáç">
                                <Edit />
                              </el-icon>
                              <el-icon class="delete-icon" @click.stop="removeTag(tag)" title="Âà†Èô§Ê†áÁ≠æ">
                                <Close />
                              </el-icon>
                            </div>
                          </div>
                          
                          <!-- ÊùÉÈáçÁºñËæëÂô® -->
                          <div v-else class="tag-weight-editor">
                            <div class="editor-content">
                              <span class="editing-tag-name">{{ tag.name }}</span>
                              <el-input-number
                                v-model="tag.editingWeight"
                                :min="0.1"
                                :max="5.0"
                                :step="0.1"
                                :precision="1"
                                size="small"
                                class="weight-editor-input"
                                @keyup.enter="confirmEditWeight(tag)"
                                @keyup.esc="cancelEditWeight(tag)"
                              />
                              <div class="weight-editor-actions">
                                <el-button 
                                  type="success" 
                                  size="small"
                                  @click="confirmEditWeight(tag)"
                                >
                                  <el-icon><Check /></el-icon>
                                </el-button>
                                <el-button 
                                  type="info" 
                                  size="small"
                                  @click="cancelEditWeight(tag)"
                                >
                                  <el-icon><Close /></el-icon>
                                </el-button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div v-else class="empty-tags">
                        <p>ÊöÇÊó†{{ tagCategories.find(cat => cat.key === category.key)?.name }}Ê†áÁ≠æ</p>
                      </div>
                    </div>

                    <!-- È¢ÑËÆæÊ†áÁ≠æ -->
                    <div class="preset-tags-section" v-if="category.key !== 'region'">
                      <h4 class="section-title">
                        È¢ÑËÆæÊ†áÁ≠æ
                        <div class="preset-actions">
                          <span class="preset-hint">ÁÇπÂáªÊ∑ªÂä† ‚Üí</span>
                          <el-button 
                            type="primary" 
                            link 
                            @click="addAllPresetTags(category)"
                            size="small"
                          >
                            ÂÖ®ÈÉ®Ê∑ªÂä†
                          </el-button>
                        </div>
                      </h4>
                      <div class="preset-tags-container">
                        <el-tag
                          v-for="presetTag in getAvailablePresetTags(category.key)"
                          :key="presetTag"
                          :type="getTagTypeByCategory(category.key)"
                          effect="plain"
                          @click="addPresetTagDirectly(category.key, presetTag)"
                          class="preset-tag-item"
                        >
                          <el-icon><Plus /></el-icon>
                          {{ presetTag }}
                        </el-tag>
                      </div>
                    </div>

                    <!-- Âú∞ÂüüÊ†áÁ≠æÁöÑÁâπÊÆäÁúÅ‰ªΩ-ÂüéÂ∏ÇÈÄâÊã©Âô® -->
                    <div class="region-selector-section" v-if="category.key === 'region'">
                      <h4 class="section-title">
                        ÁúÅ‰ªΩÂüéÂ∏ÇÈÄâÊã©Âô®
                        <div class="selector-hint">
                          <span class="selector-hint-text">ÈÄâÊã©ÁúÅ‰ªΩÂíåÂüéÂ∏ÇÔºåËá™Âä®ÁîüÊàêÂú∞Âå∫Ê†áÁ≠æ</span>
                        </div>
                      </h4>
                      
                      <div class="region-selector-container">
                        <div class="region-selector-row">
                          <el-select 
                            v-model="regionSelector.selectedProvince" 
                            placeholder="ÈÄâÊã©ÁúÅ‰ªΩ" 
                            filterable 
                            @change="handleRegionProvinceChange"
                            class="province-selector"
                          >
                            <el-option 
                              v-for="province in regionProvinces" 
                              :key="province.code" 
                              :label="province.name" 
                              :value="province.code"
                            >
                              <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>{{ province.name }}</span>
                                <el-tag size="small" type="info">{{ province.city_count }}‰∏™ÂüéÂ∏Ç</el-tag>
                              </div>
                            </el-option>
                          </el-select>
                          
                          <el-select 
                            v-model="regionSelector.selectedCity" 
                            placeholder="ÈÄâÊã©ÂüéÂ∏Ç" 
                            filterable 
                            @change="handleRegionCityChange"
                            class="city-selector"
                            :disabled="!regionSelector.availableCities.length"
                          >
                            <el-option 
                              v-for="city in regionSelector.availableCities" 
                              :key="city" 
                              :label="city" 
                              :value="city" 
                            />
                          </el-select>
                          
                          <el-button 
                            type="success" 
                            @click="addRegionTags"
                            :disabled="!regionSelector.selectedCity"
                          >
                            <el-icon><Plus /></el-icon>
                            Ê∑ªÂä†Âú∞Âå∫Ê†áÁ≠æ
                          </el-button>
                        </div>
                        
                        <!-- È¢ÑËßàÂ∞ÜË¶ÅÊ∑ªÂä†ÁöÑÊ†áÁ≠æ -->
                        <div class="region-preview" v-if="regionSelector.previewTags.length">
                          <el-text type="info" size="small">Â∞ÜÊ∑ªÂä†‰ª•‰∏ãÊ†áÁ≠æÔºö</el-text>
                          <div class="preview-tags">
                            <el-tag 
                              v-for="tag in regionSelector.previewTags" 
                              :key="tag.name"
                              :type="tag.level === 'city' ? 'success' : tag.level === 'province' ? 'info' : 'warning'"
                              size="small"
                            >
                              {{ tag.name }} ({{ tag.level === 'city' ? 'ÂüéÂ∏Ç' : tag.level === 'province' ? 'ÁúÅ‰ªΩ' : 'Âå∫Âüü' }})
                            </el-tag>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </el-tab-pane>
              </el-tabs>
            </el-card>
          </div>
        </el-tab-pane>

        <!-- Êî∂ËóèÁÆ°ÁêÜ -->
        <el-tab-pane label="Êî∂ËóèÁÆ°ÁêÜ" name="favorites">
          <div class="settings-content">
            <!-- ÊêúÁ¥¢ÂíåÁ≠õÈÄâ -->
            <el-card class="search-card">
              <!-- Âü∫Á°ÄÊêúÁ¥¢Ë°å -->
              <el-row :gutter="20" align="middle" class="search-row">
                <el-col :span="8">
                  <el-input
                    v-model="searchQuery"
                    placeholder="ÊêúÁ¥¢Êî∂ËóèÁöÑÊñáÁ´†Ê†áÈ¢ò„ÄÅÊù•Ê∫ê„ÄÅÊ†áÁ≠æ..."
                    size="large"
                    clearable
                    @input="handleSearch"
                    @clear="handleSearchClear"
                    @keyup.enter="performSearch"
                  >
                    <template #prefix>
                      <el-icon><Search /></el-icon>
                    </template>
                  </el-input>
                </el-col>
                <el-col :span="3">
                  <el-button 
                    type="primary" 
                    size="large" 
                    @click="performSearch"
                    :loading="favoritesLoading"
                    style="width: 100%"
                  >
                    <el-icon><Search /></el-icon>
                    ÊêúÁ¥¢
                  </el-button>
                </el-col>
                <el-col :span="3">
                  <el-button 
                    size="large" 
                    @click="resetAllFilters"
                    style="width: 100%"
                  >
                    <el-icon><Refresh /></el-icon>
                    ÈáçÁΩÆ
                  </el-button>
                </el-col>
                <el-col :span="3">
                  <el-button 
                    :type="showAdvancedFilters ? 'primary' : ''"
                    size="large" 
                    @click="toggleAdvancedFilters"
                    style="width: 100%"
                  >
                    <el-icon><Setting /></el-icon>
                    Á≠õÈÄâ
                  </el-button>
                </el-col>
                <el-col :span="7">
                  <div class="search-stats">
                    <span class="search-result-text">
                      <template v-if="hasActiveFilters">
                        Á≠õÈÄâÂà∞ <strong>{{ filteredFavorites.length }}</strong> ÁØáÊñáÁ´†
                      </template>
                      <template v-else-if="searchQuery">
                        ÊêúÁ¥¢Âà∞ <strong>{{ filteredFavorites.length }}</strong> ÁØáÊñáÁ´†
                      </template>
                      <template v-else>
                        ÂÖ± <strong>{{ favorites.length }}</strong> ÁØáÊî∂Ëóè
                      </template>
                    </span>
                  </div>
                </el-col>
              </el-row>

              <!-- È´òÁ∫ßÁ≠õÈÄâÈù¢Êùø -->
              <el-collapse-transition>
                <div v-show="showAdvancedFilters" class="advanced-filters">
                  <el-divider content-position="left">
                    <el-icon><Setting /></el-icon>
                    È´òÁ∫ßÁ≠õÈÄâ
                  </el-divider>
                  
                  <el-row :gutter="16" class="filter-row">
                    <!-- ÂÜÖÂÆπÁ±ªÂûãÁ≠õÈÄâ -->
                    <el-col :span="6">
                      <div class="filter-group">
                        <label class="filter-label">ÂÜÖÂÆπÁ±ªÂûã</label>
                        <el-select 
                          v-model="filters.contentType" 
                          placeholder="ÈÄâÊã©ÂÜÖÂÆπÁ±ªÂûã"
                          clearable
                          @change="applyFilters"
                          style="width: 100%"
                        >
                          <el-option label="ÂÖ®ÈÉ®Á±ªÂûã" value="" />
                          <el-option 
                            v-for="(count, type) in contentTypeStats" 
                            :key="type"
                            :label="`${getContentTypeLabel(type)} (${count})`"
                            :value="type"
                          >
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                              <el-tag :type="getContentTypeColor(type)" size="small">
                                {{ getContentTypeLabel(type) }}
                              </el-tag>
                              <span style="color: #8492a6; font-size: 12px;">{{ count }}ÁØá</span>
                            </div>
                          </el-option>
                        </el-select>
                      </div>
                    </el-col>

                    <!-- ËÉΩÊ∫êÁ±ªÂûãÁ≠õÈÄâ -->
                    <el-col :span="6">
                      <div class="filter-group">
                        <label class="filter-label">ËÉΩÊ∫êÁ±ªÂûã</label>
                        <el-select 
                          v-model="filters.energyType" 
                          placeholder="ÈÄâÊã©ËÉΩÊ∫êÁ±ªÂûã"
                          clearable
                          filterable
                          @change="applyFilters"
                          style="width: 100%"
                        >
                          <el-option label="ÂÖ®ÈÉ®ËÉΩÊ∫ê" value="" />
                          <el-option 
                            v-for="(count, energyType) in allEnergyTypeStats" 
                            :key="energyType"
                            :label="`${energyType} (${count})`"
                            :value="energyType"
                          >
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                              <el-tag type="warning" size="small">{{ energyType }}</el-tag>
                              <span style="color: #8492a6; font-size: 12px;">{{ count }}ÁØá</span>
                            </div>
                          </el-option>
                        </el-select>
                      </div>
                    </el-col>

                    <!-- Âú∞Âå∫Á≠õÈÄâ -->
                    <el-col :span="6">
                      <div class="filter-group">
                        <label class="filter-label">Âú∞Âå∫</label>
                        <el-select 
                          v-model="filters.region" 
                          placeholder="ÈÄâÊã©Âú∞Âå∫"
                          clearable
                          filterable
                          @change="applyFilters"
                          style="width: 100%"
                        >
                          <el-option label="ÂÖ®ÈÉ®Âú∞Âå∫" value="" />
                          <el-option 
                            v-for="(count, region) in allRegionStats" 
                            :key="region"
                            :label="`${region} (${count})`"
                            :value="region"
                          >
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                              <el-tag type="success" size="small">{{ region }}</el-tag>
                              <span style="color: #8492a6; font-size: 12px;">{{ count }}ÁØá</span>
                            </div>
                          </el-option>
                        </el-select>
                      </div>
                    </el-col>

                    <!-- Êó∂Èó¥ËåÉÂõ¥Á≠õÈÄâ -->
                    <el-col :span="6">
                      <div class="filter-group">
                        <label class="filter-label">Êî∂ËóèÊó∂Èó¥</label>
                        <el-select 
                          v-model="filters.timeRange" 
                          placeholder="ÈÄâÊã©Êó∂Èó¥ËåÉÂõ¥"
                          clearable
                          @change="applyFilters"
                          style="width: 100%"
                        >
                          <el-option label="ÂÖ®ÈÉ®Êó∂Èó¥" value="" />
                          <el-option label="ÊúÄËøë7Â§©" value="7days" />
                          <el-option label="ÊúÄËøë30Â§©" value="30days" />
                          <el-option label="ÊúÄËøë3‰∏™Êúà" value="3months" />
                          <el-option label="ÊúÄËøë6‰∏™Êúà" value="6months" />
                          <el-option label="ÊúÄËøë1Âπ¥" value="1year" />
                        </el-select>
                      </div>
                    </el-col>
                  </el-row>

                  <!-- ÊàëÁöÑÊ†áÁ≠æÁ≠õÈÄâ -->
                  <el-row class="filter-row">
                    <el-col :span="24">
                      <div class="filter-group">
                        <label class="filter-label">
                          <el-icon><InfoFilled /></el-icon>
                          ÊåâÊàëÁöÑÊ†áÁ≠æÁ≠õÈÄâ
                        </label>
                        <div class="my-tags-filter">
                          <el-tag
                            v-for="tag in availableUserTags"
                            :key="tag.name"
                            :type="filters.userTags.includes(tag.name) ? getTagTypeByCategory(tag.category) : 'info'"
                            :effect="filters.userTags.includes(tag.name) ? 'dark' : 'plain'"
                            @click="toggleUserTagFilter(tag.name)"
                            class="user-tag-filter"
                          >
                            <el-icon v-if="filters.userTags.includes(tag.name)"><Check /></el-icon>
                            {{ tag.name }}
                            <span class="tag-weight">({{ tag.weight }}x)</span>
                          </el-tag>
                        </div>
                      </div>
                    </el-col>
                  </el-row>

                  <!-- Á≠õÈÄâÁªìÊûúÁªüËÆ° -->
                  <div class="filter-summary" v-if="hasActiveFilters">
                    <el-alert 
                      :title="`Â∑≤Â∫îÁî® ${activeFiltersCount} ‰∏™Á≠õÈÄâÊù°‰ª∂ÔºåÊâæÂà∞ ${filteredFavorites.length} ÁØáÊñáÁ´†`"
                      type="info" 
                      :closable="false"
                      show-icon
                    >
                      <template #default>
                        <div class="active-filters">
                          <el-tag 
                            v-if="filters.contentType"
                            type="primary" 
                            closable 
                            @close="filters.contentType = ''; applyFilters()"
                          >
                            Á±ªÂûã: {{ getContentTypeLabel(filters.contentType) }}
                          </el-tag>
                          <el-tag 
                            v-if="filters.energyType"
                            type="warning" 
                            closable 
                            @close="filters.energyType = ''; applyFilters()"
                          >
                            ËÉΩÊ∫ê: {{ filters.energyType }}
                          </el-tag>
                          <el-tag 
                            v-if="filters.region"
                            type="success" 
                            closable 
                            @close="filters.region = ''; applyFilters()"
                          >
                            Âú∞Âå∫: {{ filters.region }}
                          </el-tag>
                          <el-tag 
                            v-if="filters.timeRange"
                            type="info" 
                            closable 
                            @close="filters.timeRange = ''; applyFilters()"
                          >
                            Êó∂Èó¥: {{ getTimeRangeLabel(filters.timeRange) }}
                          </el-tag>
                          <el-tag 
                            v-for="userTag in filters.userTags"
                            :key="userTag"
                            type="danger" 
                            closable 
                            @close="toggleUserTagFilter(userTag)"
                          >
                            Ê†áÁ≠æ: {{ userTag }}
                          </el-tag>
                        </div>
                      </template>
                    </el-alert>
                  </div>
                </div>
              </el-collapse-transition>
            </el-card>

            <!-- Êî∂ËóèÊñáÁ´†ÂàóË°® -->
            <el-card class="favorites-card">
              <template #header>
                <div class="card-header">
                  <span class="card-title">Êî∂ËóèÊñáÁ´†</span>
                  <el-button type="primary" @click="loadFavorites" :loading="favoritesLoading">
                    <el-icon><Refresh /></el-icon>
                    Âà∑Êñ∞
                  </el-button>
                </div>
              </template>

              <div v-loading="favoritesLoading" class="favorites-list">
                <div v-if="filteredFavorites.length === 0 && !favoritesLoading" class="empty-state">
                  <el-empty :description="hasActiveFilters ? 'Ê≤°ÊúâÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑÊî∂ËóèÊñáÁ´†' : 'ËøòÊ≤°ÊúâÊî∂Ëóè‰ªª‰ΩïÊñáÁ´†'">
                    <el-button v-if="hasActiveFilters" type="primary" @click="resetAllFilters">
                      Ê∏ÖÈô§Á≠õÈÄâÊù°‰ª∂
                    </el-button>
                    <el-button v-else type="primary" @click="$router.push('/content')">
                      ÂéªÂèëÁé∞ÂÜÖÂÆπ
                    </el-button>
                  </el-empty>
                </div>

                <div v-else class="favorite-items">
                  <el-card 
                    v-for="item in filteredFavorites" 
                    :key="item._id"
                    class="favorite-item"
                    shadow="hover"
                  >
                    <div class="favorite-item-body">
                      <div class="favorite-main">
                        <div class="favorite-meta">
                          <el-tag 
                            :type="getContentTypeColor(item.type)" 
                            size="small"
                            class="content-type-tag"
                          >
                            {{ getContentTypeLabel(item.type) }}
                          </el-tag>
                          <span class="favorite-source">{{ item.source }}</span>
                          <span class="favorite-date">Êî∂Ëóè‰∫é {{ formatDate(item.favorited_at) }}</span>
                        </div>
                        <h3 class="favorite-title">
                          <a 
                            v-if="item.link" 
                            :href="item.link" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="article-link"
                          >
                            {{ item.title }}
                            <el-icon class="external-link-icon"><TopRight /></el-icon>
                          </a>
                          <span v-else>{{ item.title }}</span>
                        </h3>
                        <p class="favorite-publish-date">ÂèëÂ∏É‰∫é {{ formatDate(item.publish_date) }}</p>
                        <div class="favorite-tags" v-if="getAllTagsFromFavorite(item).length">
                          <el-tag 
                            v-for="tag in getAllTagsFromFavorite(item).slice(0, 8)" 
                            :key="tag"
                            size="small"
                            class="favorite-tag"
                            :type="getTagColor(tag)"
                          >
                            {{ tag }}
                          </el-tag>
                          <span v-if="getAllTagsFromFavorite(item).length > 8" class="more-tags">
                            +{{ getAllTagsFromFavorite(item).length - 8 }}
                          </span>
                        </div>
                      </div>
                      <div class="favorite-actions">
                        <el-button type="danger" link @click="removeFavorite(item)">
                          <el-icon><Delete /></el-icon>
                          ÂèñÊ∂àÊî∂Ëóè
                        </el-button>
                      </div>
                    </div>
                  </el-card>
                </div>
              </div>
            </el-card>

            <!-- Êî∂ËóèÁªüËÆ°ÂàÜÊûê -->
            <el-card class="stats-analysis-card" v-if="favorites.length > 0">
              <template #header>
                <div class="card-header">
                  <span class="card-title">Êî∂ËóèÁªüËÆ°ÂàÜÊûê</span>
                </div>
              </template>

              <el-row :gutter="24">
                <!-- ÂÜÖÂÆπÁ±ªÂûãÁªüËÆ° -->
                <el-col :span="8">
                  <div class="stats-section-item">
                    <h4 class="stats-section-title">
                      <el-icon><InfoFilled /></el-icon>
                      ÂÜÖÂÆπÁ±ªÂûãÂàÜÂ∏É
                    </h4>
                    <div class="stats-chart">
                      <div 
                        v-for="(count, type) in contentTypeStats" 
                        :key="type"
                        class="stats-bar-item"
                      >
                        <div class="stats-bar-label">
                          <el-tag 
                            :type="getContentTypeColor(type)" 
                            size="small"
                          >
                            {{ getContentTypeLabel(type) }}
                          </el-tag>
                          <span class="stats-count">{{ count }}ÁØá</span>
                        </div>
                        <div class="stats-bar">
                          <div 
                            class="stats-bar-fill"
                            :style="{ 
                              width: `${(count / favorites.length) * 100}%`,
                              backgroundColor: getContentTypeBarColor(type)
                            }"
                          ></div>
                        </div>
                        <span class="stats-percentage">{{ Math.round((count / favorites.length) * 100) }}%</span>
                      </div>
                    </div>
                  </div>
                </el-col>

                <!-- ËÉΩÊ∫êÁ±ªÂûãÁªüËÆ° -->
                <el-col :span="8">
                  <div class="stats-section-item">
                    <h4 class="stats-section-title">
                      <el-icon>‚ö°</el-icon>
                      ËÉΩÊ∫êÁ±ªÂûãÂÖ≥Ê≥®Â∫¶
                    </h4>
                    <div class="stats-chart">
                      <div 
                        v-for="(count, energyType) in energyTypeStats" 
                        :key="energyType"
                        class="stats-bar-item"
                      >
                        <div class="stats-bar-label">
                          <el-tag type="warning" size="small">{{ energyType }}</el-tag>
                          <span class="stats-count">{{ count }}ÁØá</span>
                        </div>
                        <div class="stats-bar">
                          <div 
                            class="stats-bar-fill"
                            :style="{ 
                              width: `${(count / favorites.length) * 100}%`,
                              backgroundColor: '#f39c12'
                            }"
                          ></div>
                        </div>
                        <span class="stats-percentage">{{ Math.round((count / favorites.length) * 100) }}%</span>
                      </div>
                    </div>
                  </div>
                </el-col>

                <!-- Âú∞Âå∫ÁªüËÆ° -->
                <el-col :span="8">
                  <div class="stats-section-item">
                    <h4 class="stats-section-title">
                      <el-icon>üåç</el-icon>
                      Âú∞Âå∫ÂÖ≥Ê≥®Â∫¶
                    </h4>
                    <div class="stats-chart">
                      <div 
                        v-for="(count, region) in regionStats" 
                        :key="region"
                        class="stats-bar-item"
                      >
                        <div class="stats-bar-label">
                          <el-tag type="success" size="small">{{ region }}</el-tag>
                          <span class="stats-count">{{ count }}ÁØá</span>
                        </div>
                        <div class="stats-bar">
                          <div 
                            class="stats-bar-fill"
                            :style="{ 
                              width: `${(count / favorites.length) * 100}%`,
                              backgroundColor: '#27ae60'
                            }"
                          ></div>
                        </div>
                        <span class="stats-percentage">{{ Math.round((count / favorites.length) * 100) }}%</span>
                      </div>
                    </div>
                  </div>
                </el-col>
              </el-row>

              <!-- Êî∂ËóèË∂ãÂäø -->
              <el-divider />
              <div class="stats-section-item">
                <h4 class="stats-section-title">
                  <el-icon>üìà</el-icon>
                  Êî∂ËóèË∂ãÂäøÂàÜÊûê
                </h4>
                <el-row :gutter="16" class="trend-stats">
                  <el-col :span="6">
                    <div class="trend-item">
                      <div class="trend-value">{{ recentFavoritesCount }}</div>
                      <div class="trend-label">Ëøë7Â§©Êî∂Ëóè</div>
                    </div>
                  </el-col>
                  <el-col :span="6">
                    <div class="trend-item">
                      <div class="trend-value">{{ monthlyFavoritesCount }}</div>
                      <div class="trend-label">Ëøë30Â§©Êî∂Ëóè</div>
                    </div>
                  </el-col>
                  <el-col :span="6">
                    <div class="trend-item">
                      <div class="trend-value">{{ averageFavoritesPerDay }}</div>
                      <div class="trend-label">Êó•ÂùáÊî∂Ëóè</div>
                    </div>
                  </el-col>
                  <el-col :span="6">
                    <div class="trend-item">
                      <div class="trend-value">{{ mostActiveDay }}</div>
                      <div class="trend-label">ÊúÄÊ¥ªË∑ÉÊó•Êúü</div>
                    </div>
                  </el-col>
                </el-row>
              </div>
            </el-card>
          </div>
        </el-tab-pane>
      </el-tabs>
    </el-card>

    <!-- È°µÈù¢ÂÆΩÂ∫¶Âç†‰ΩçÁ¨¶ -->
    <div class="width-placeholder" aria-hidden="true"></div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch, reactive } from 'vue'
import { 
  Setting, 
  Refresh, 
  Check, 
  RefreshLeft,
  Delete, 
  Edit, 
  Close, 
  Plus,
  InfoFilled,
  Search,
  TopRight
} from '@element-plus/icons-vue'
import api from '@/api/request'
import { useUserStore } from '@/store/user'
import { ElMessage, ElMessageBox } from 'element-plus'
import tagService, { type TagCategory } from '@/services/tagService'
import { favoritesAPI, type FavoriteItem, type UserBehaviorStats } from '@/api/favorites'

interface UserTag {
  category: string;
  name: string;
  weight: number;
  source: string;
  created_at: string;
  isEditing?: boolean;
  editingWeight?: number;
}

const userStore = useUserStore()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const activeSettingTab = ref('tags')
const loading = ref(false)
const saving = ref(false)
const error = ref('')
const activeTab = ref('region')
const hasChanges = ref(false)

// Ê†áÁ≠æÊï∞ÊçÆ
const tags = ref<UserTag[]>([])
const originalTags = ref<UserTag[]>([])

// Ê†áÁ≠æÂàÜÁ±ªÈÖçÁΩÆ
const tagCategories = ref<TagCategory[]>([])

// Âú∞ÂüüÈÄâÊã©Âô®Êï∞ÊçÆ
const regionProvinces = ref([])
const regionSelector = reactive({
  selectedProvince: '',
  selectedCity: '',
  availableCities: [],
  previewTags: []
})

// Êî∂ËóèÁÆ°ÁêÜÁõ∏ÂÖ≥Êï∞ÊçÆ
const searchQuery = ref('')
const favorites = ref<FavoriteItem[]>([])
const favoritesLoading = ref(false)
const behaviorStats = ref<UserBehaviorStats>({
  user_id: '',
  total_favorites: 0,
  energy_type_interests: {},
  region_interests: {},
  last_activity: ''
})

// Á≠õÈÄâÂäüËÉΩÁõ∏ÂÖ≥Êï∞ÊçÆ
const showAdvancedFilters = ref(false)
const filters = reactive({
  contentType: '',
  energyType: '',
  region: '',
  timeRange: '',
  userTags: [] as string[]
})

// Êî∂ËóèÁÆ°ÁêÜÁõ∏ÂÖ≥ËÆ°ÁÆóÂ±ûÊÄß
const lastActivityText = computed(() => {
  if (behaviorStats.value.last_activity) {
    return formatDate(behaviorStats.value.last_activity)
  }
  return 'Êó†'
})

// Êî∂ËóèÁªüËÆ°Áõ∏ÂÖ≥ËÆ°ÁÆóÂ±ûÊÄß
const contentTypeStats = computed(() => {
  const stats: Record<string, number> = {}
  favorites.value.forEach(item => {
    const type = item.type || 'other'
    stats[type] = (stats[type] || 0) + 1
  })
  return stats
})

const energyTypeStats = computed(() => {
  const stats: Record<string, number> = {}
  favorites.value.forEach(item => {
    if (item.energy_type_tags && item.energy_type_tags.length > 0) {
      item.energy_type_tags.forEach(tag => {
        stats[tag] = (stats[tag] || 0) + 1
      })
    }
  })
  // Âè™ËøîÂõûÂâç5‰∏™ÊúÄÂ∏∏ËßÅÁöÑËÉΩÊ∫êÁ±ªÂûã
  return Object.fromEntries(
    Object.entries(stats)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 5)
  )
})

const regionStats = computed(() => {
  const stats: Record<string, number> = {}
  favorites.value.forEach(item => {
    if (item.region_tags && item.region_tags.length > 0) {
      item.region_tags.forEach(tag => {
        stats[tag] = (stats[tag] || 0) + 1
      })
    }
  })
  // Âè™ËøîÂõûÂâç5‰∏™ÊúÄÂ∏∏ËßÅÁöÑÂú∞Âå∫
  return Object.fromEntries(
    Object.entries(stats)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 5)
  )
})

const recentFavoritesCount = computed(() => {
  const sevenDaysAgo = new Date()
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)
  return favorites.value.filter(item => 
    new Date(item.favorited_at) >= sevenDaysAgo
  ).length
})

const monthlyFavoritesCount = computed(() => {
  const thirtyDaysAgo = new Date()
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)
  return favorites.value.filter(item => 
    new Date(item.favorited_at) >= thirtyDaysAgo
  ).length
})

const averageFavoritesPerDay = computed(() => {
  if (favorites.value.length === 0) return '0'
  const thirtyDaysAgo = new Date()
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)
  const recentFavorites = favorites.value.filter(item => 
    new Date(item.favorited_at) >= thirtyDaysAgo
  )
  return (recentFavorites.length / 30).toFixed(1)
})

const mostActiveDay = computed(() => {
  if (favorites.value.length === 0) return 'Êó†'
  const dayStats: Record<string, number> = {}
  favorites.value.forEach(item => {
    const day = new Date(item.favorited_at).toLocaleDateString('zh-CN')
    dayStats[day] = (dayStats[day] || 0) + 1
  })
  const mostActive = Object.entries(dayStats)
    .sort(([,a], [,b]) => b - a)[0]
  return mostActive ? mostActive[0] : 'Êó†'
})

// Á≠õÈÄâÂäüËÉΩÁõ∏ÂÖ≥ËÆ°ÁÆóÂ±ûÊÄß
const allEnergyTypeStats = computed(() => {
  const stats: Record<string, number> = {}
  favorites.value.forEach(item => {
    if (item.energy_type_tags && item.energy_type_tags.length > 0) {
      item.energy_type_tags.forEach(tag => {
        stats[tag] = (stats[tag] || 0) + 1
      })
    }
  })
  return Object.fromEntries(
    Object.entries(stats).sort(([,a], [,b]) => b - a)
  )
})

const allRegionStats = computed(() => {
  const stats: Record<string, number> = {}
  favorites.value.forEach(item => {
    if (item.region_tags && item.region_tags.length > 0) {
      item.region_tags.forEach(tag => {
        stats[tag] = (stats[tag] || 0) + 1
      })
    }
  })
  return Object.fromEntries(
    Object.entries(stats).sort(([,a], [,b]) => b - a)
  )
})

const availableUserTags = computed(() => {
  return tags.value.filter(tag => 
    tag.category !== 'basic_info' && 
    ['region', 'energy_type', 'business_field', 'policy_measure'].includes(tag.category)
  )
})

const hasActiveFilters = computed(() => {
  return !!(
    filters.contentType || 
    filters.energyType || 
    filters.region || 
    filters.timeRange || 
    filters.userTags.length > 0
  )
})

const activeFiltersCount = computed(() => {
  let count = 0
  if (filters.contentType) count++
  if (filters.energyType) count++
  if (filters.region) count++
  if (filters.timeRange) count++
  if (filters.userTags.length > 0) count += filters.userTags.length
  return count
})

const filteredFavorites = computed(() => {
  let result = [...favorites.value]
  
  // ÊêúÁ¥¢ÂÖ≥ÈîÆËØçÁ≠õÈÄâ
  if (searchQuery.value.trim()) {
    const query = searchQuery.value.toLowerCase()
    result = result.filter(item => 
      item.title.toLowerCase().includes(query) ||
      item.source.toLowerCase().includes(query) ||
      getAllTagsFromFavorite(item).some(tag => tag.toLowerCase().includes(query))
    )
  }
  
  // ÂÜÖÂÆπÁ±ªÂûãÁ≠õÈÄâ
  if (filters.contentType) {
    result = result.filter(item => item.type === filters.contentType)
  }
  
  // ËÉΩÊ∫êÁ±ªÂûãÁ≠õÈÄâ
  if (filters.energyType) {
    result = result.filter(item => 
      item.energy_type_tags && item.energy_type_tags.includes(filters.energyType)
    )
  }
  
  // Âú∞Âå∫Á≠õÈÄâ
  if (filters.region) {
    result = result.filter(item => 
      item.region_tags && item.region_tags.includes(filters.region)
    )
  }
  
  // Êó∂Èó¥ËåÉÂõ¥Á≠õÈÄâ
  if (filters.timeRange) {
    const now = new Date()
    let startDate = new Date()
    
    switch (filters.timeRange) {
      case '7days':
        startDate.setDate(now.getDate() - 7)
        break
      case '30days':
        startDate.setDate(now.getDate() - 30)
        break
      case '3months':
        startDate.setMonth(now.getMonth() - 3)
        break
      case '6months':
        startDate.setMonth(now.getMonth() - 6)
        break
      case '1year':
        startDate.setFullYear(now.getFullYear() - 1)
        break
    }
    
    result = result.filter(item => 
      new Date(item.favorited_at) >= startDate
    )
  }
  
  // Áî®Êà∑Ê†áÁ≠æÁ≠õÈÄâ
  if (filters.userTags.length > 0) {
    result = result.filter(item => {
      const itemTags = getAllTagsFromFavorite(item)
      return filters.userTags.some(userTag => itemTags.includes(userTag))
    })
  }
  
  return result
})

// ËÆ°ÁÆóÂ±ûÊÄß
const totalTagsCount = computed(() => tags.value.length)
const activeCategoriesCount = computed(() => {
  const categories = new Set(tags.value.map(tag => tag.category))
  return categories.size
})
const totalWeight = computed(() => {
  return tags.value.reduce((sum, tag) => sum + tag.weight, 0)
})
const lastUpdateTime = computed(() => {
  if (!tags.value.length) return 'Êó†'
  const dates = tags.value.map(tag => new Date(tag.created_at))
  const latest = new Date(Math.max(...dates.map(d => d.getTime())))
  return latest.toLocaleDateString('zh-CN')
})

const sortedTagsForPreview = computed(() => {
  return [...tags.value].sort((a, b) => b.weight - a.weight)
})

// Â∑•ÂÖ∑ÂáΩÊï∞
const getTagsByCategory = (category: string) => {
  return tags.value.filter(tag => tag.category === category)
}

const getAvailablePresetTags = (category: string) => {
  const categoryConfig = tagCategories.value.find(cat => cat.key === category)
  if (!categoryConfig) return []
  
  const existingTagNames = getTagsByCategory(category).map(tag => tag.name)
  return categoryConfig.presetTags.filter(preset => !existingTagNames.includes(preset))
}

const getTagTypeByCategory = (category: string) => {
  const categoryConfig = tagCategories.value.find(cat => cat.key === category)
  return categoryConfig?.color || 'info'
}

const getBadgeType = (category: string) => {
  const count = getTagsByCategory(category).length
  if (count === 0) return 'info'
  if (count <= 2) return 'warning'
  return 'success'
}

const getTagSizeByWeight = (weight: number) => {
  if (weight >= 2.0) return 'large'
  if (weight >= 1.5) return 'default'
  return 'small'
}

// Ê†áÁ≠æÊìç‰ΩúÊñπÊ≥ï
const addPresetTagDirectly = (category: string, tagName: string) => {
  if (tags.value.find(tag => tag.category === category && tag.name === tagName)) {
    ElMessage.warning('ËØ•Ê†áÁ≠æÂ∑≤Â≠òÂú®')
    return
  }
  
  tags.value.push({
    category,
    name: tagName,
    weight: 1.0,
    source: 'preset',
    created_at: new Date().toISOString()
  })
  
  hasChanges.value = true
  ElMessage.success(`Â∑≤Ê∑ªÂä†È¢ÑËÆæÊ†áÁ≠æÔºö${tagName}`)
}

const addAllPresetTags = async (category: any) => {
  const result = await ElMessageBox.confirm(
    `Á°ÆÂÆöË¶ÅÊ∑ªÂä†ÊâÄÊúâ${category.name}ÁöÑÈ¢ÑËÆæÊ†áÁ≠æÂêóÔºü`,
    'ÊâπÈáèÊ∑ªÂä†Á°ÆËÆ§',
    {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'info'
    }
  ).catch(() => false)
  
  if (!result) return
  
  const availableTags = getAvailablePresetTags(category.key)
  let addedCount = 0
  availableTags.forEach(tagName => {
    if (!tags.value.find(tag => tag.category === category.key && tag.name === tagName)) {
      tags.value.push({
        category: category.key,
        name: tagName,
        weight: 1.0,
        source: 'preset',
        created_at: new Date().toISOString()
      })
      addedCount++
    }
  })
  
  hasChanges.value = true
  ElMessage.success(`Â∑≤Ê∑ªÂä†${addedCount}‰∏™È¢ÑËÆæÊ†áÁ≠æ`)
}

const removeTag = async (tag: UserTag) => {
  const result = await ElMessageBox.confirm(
    `Á°ÆÂÆöË¶ÅÂà†Èô§Ê†áÁ≠æ"${tag.name}"ÂêóÔºü`,
    'Âà†Èô§Á°ÆËÆ§',
    {
      confirmButtonText: 'Âà†Èô§',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    }
  ).catch(() => false)
  
  if (!result) return
  
  const index = tags.value.findIndex(t => t.category === tag.category && t.name === tag.name)
  if (index !== -1) {
    tags.value.splice(index, 1)
    hasChanges.value = true
    ElMessage.success(`Â∑≤Âà†Èô§Ê†áÁ≠æÔºö${tag.name}`)
  }
}

const startEditWeight = (tag: UserTag) => {
  tag.isEditing = true
  tag.editingWeight = tag.weight
}

const confirmEditWeight = (tag: UserTag) => {
  if (tag.editingWeight !== undefined) {
    tag.weight = tag.editingWeight
    hasChanges.value = true
  }
  tag.isEditing = false
  tag.editingWeight = undefined
  ElMessage.success(`Â∑≤Êõ¥Êñ∞Ê†áÁ≠æÊùÉÈáçÔºö${tag.name}`)
}

const cancelEditWeight = (tag: UserTag) => {
  tag.isEditing = false
  tag.editingWeight = undefined
}

const resetToDefaults = async () => {
  const result = await ElMessageBox.confirm(
    'Á°ÆÂÆöË¶ÅÈáçÁΩÆÊ†áÁ≠æÂêóÔºüËøôÂ∞Ü‰øùÁïôÊ≥®ÂÜåÂú∞„ÄÅÁúÅ‰ªΩ„ÄÅÂå∫ÂüüÂíåËÉΩÊ∫ê‰∫ßÂìÅÊ†áÁ≠æÔºåÊ∏ÖÁêÜÂÖ∂‰ªñÊ†áÁ≠æ„ÄÇ',
    'ÈáçÁΩÆÁ°ÆËÆ§',
    {
      confirmButtonText: 'ÈáçÁΩÆ',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    }
  ).catch(() => false)
  
  if (!result) return
  
  const preserveCategories = ['region', 'energy_type']
  tags.value = tags.value.filter(tag => preserveCategories.includes(tag.category))
  hasChanges.value = true
  ElMessage.success('Â∑≤ÈáçÁΩÆÊ†áÁ≠æ')
}

const cleanDuplicates = () => {
  const seen = new Set()
  const cleaned = tags.value.filter(tag => {
    const key = `${tag.category}-${tag.name}`
    if (seen.has(key)) {
      return false
    }
    seen.add(key)
    return true
  })
  
  const duplicateCount = tags.value.length - cleaned.length
  if (duplicateCount > 0) {
    tags.value = cleaned
    hasChanges.value = true
    ElMessage.success(`Â∑≤Ê∏ÖÁêÜ${duplicateCount}‰∏™ÈáçÂ§çÊ†áÁ≠æ`)
  } else {
    ElMessage.info('Ê≤°ÊúâÂèëÁé∞ÈáçÂ§çÊ†áÁ≠æ')
  }
}

const fetchTags = async () => {
  try {
    loading.value = true
    error.value = ''
    
    const userId = userStore.currentUser?.demo_user_id || userStore.currentUser?.id
    if (!userId) {
      throw new Error('ËØ∑ÂÖàÁôªÂΩï')
    }
    
    console.log('üè∑Ô∏è Ëé∑ÂèñÁî®Êà∑Ê†áÁ≠æ - userId:', userId)
    const response = await api.get(`/users/${userId}/tags`)
    
    if (response.data?.data?.tags) {
      // Â§ÑÁêÜÊ†áÁ≠æÊï∞ÊçÆÂπ∂ÂéªÈáç
      let rawTags = response.data.data.tags
      
      // Êò†Â∞ÑÊ†áÁ≠æÂàÜÁ±ªÔºàÂ§ÑÁêÜÂêéÁ´ØÂèØËÉΩËøîÂõûÁöÑÂüéÂ∏Ç„ÄÅÁúÅ‰ªΩÁ≠âÊ†áÁ≠æÔºâ
      rawTags = rawTags.map(tag => {
        if (['city', 'province'].includes(tag.category)) {
          return { ...tag, category: 'region' }
        }
        return tag
      })
      
      // ËøáÊª§ÊéâÂü∫Á°Ä‰ø°ÊÅØÊ†áÁ≠æ
      rawTags = rawTags.filter(tag => tag.category !== 'basic_info')
      
      tags.value = rawTags || []
      originalTags.value = JSON.parse(JSON.stringify(tags.value))
      hasChanges.value = false
      
      console.log('‚úÖ Ê†áÁ≠æÂä†ËΩΩÊàêÂäüÔºåÊï∞Èáè:', tags.value.length)
      ElMessage.success(`ÊàêÂäüÂä†ËΩΩ${tags.value.length}‰∏™Ê†áÁ≠æ`)
    } else {
      tags.value = []
      originalTags.value = []
      ElMessage.info('ÊöÇÊó†Ê†áÁ≠æÔºåËØ∑Ê∑ªÂä†ÊÇ®ÊÑüÂÖ¥Ë∂£ÁöÑÊ†áÁ≠æ')
    }
  } catch (err: any) {
    console.error('‚ùå Ëé∑ÂèñÊ†áÁ≠æÂ§±Ë¥•:', err)
    error.value = err.response?.data?.message || err.message || 'Ëé∑ÂèñÊ†áÁ≠æÂ§±Ë¥•'
    ElMessage.error(error.value)
  } finally {
    loading.value = false
  }
}

const saveUserTags = async () => {
  if (!hasChanges.value) {
    ElMessage.info('Ê≤°ÊúâÊõ¥ÊîπÈúÄË¶Å‰øùÂ≠ò')
    return
  }
  
  try {
    saving.value = true
    
    const userId = userStore.currentUser?.demo_user_id || userStore.currentUser?.id
    if (!userId) {
      throw new Error('ËØ∑ÂÖàÁôªÂΩï')
    }
    
    const tagsData = {
      tags: tags.value.map(tag => ({
        category: tag.category,
        name: tag.name,
        weight: tag.weight || 1.0,
        source: tag.source || 'manual',
        created_at: tag.created_at || new Date().toISOString()
      }))
    }
    
    console.log('üíæ ‰øùÂ≠òÁî®Êà∑Ê†áÁ≠æ:', {
      ÊÄªÊï∞: tagsData.tags.length
    })
    
    await api.put(`/users/${userId}/tags`, tagsData)
    
    originalTags.value = JSON.parse(JSON.stringify(tags.value))
    hasChanges.value = false
    ElMessage.success(`‚úÖ ÊàêÂäü‰øùÂ≠ò ${tags.value.length} ‰∏™Ê†áÁ≠æ`)
  } catch (err: any) {
    console.error('‚ùå ‰øùÂ≠òÊ†áÁ≠æÂ§±Ë¥•:', err)
    
    let errorMessage = '‰øùÂ≠òÂ§±Ë¥•'
    if (err.response?.status === 400) {
      errorMessage = `È™åËØÅÂ§±Ë¥•Ôºö${err.response.data?.detail?.message || 'Ê†áÁ≠æÈ™åËØÅÂ§±Ë¥•'}`
    } else if (err.response?.status === 500) {
      errorMessage = 'ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï'
    } else {
      errorMessage = err.response?.data?.message || err.message || '‰øùÂ≠òÂ§±Ë¥•'
    }
    
    ElMessage.error(errorMessage)
  } finally {
    saving.value = false
  }
}

// ÂàùÂßãÂåñÊï∞ÊçÆ
onMounted(async () => {
  try {
    tagCategories.value = await tagService.getTagCategories()
    await loadProvincesWithCities()
    await fetchTags()
    
    // Â¶ÇÊûúÂΩìÂâçÊòØÊî∂ËóèÁÆ°ÁêÜÈ°µÁ≠æÔºåÂàôÂä†ËΩΩÊî∂ËóèÊï∞ÊçÆ
    if (activeSettingTab.value === 'favorites') {
      await loadFavorites()
    }
  } catch (err) {
    console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', err)
    error.value = 'ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï'
  }
})

// ÁõëÂê¨È°µÁ≠æÂàáÊç¢ÔºåËá™Âä®Âä†ËΩΩÂØπÂ∫îÊï∞ÊçÆ
watch(activeSettingTab, async (newTab) => {
  if (newTab === 'favorites' && favorites.value.length === 0) {
    await loadFavorites()
  }
})

// Âú∞ÂüüÈÄâÊã©Âô®Áõ∏ÂÖ≥ÂáΩÊï∞
const loadProvincesWithCities = async () => {
  try {
    console.log('üåç ÂºÄÂßãÂä†ËΩΩÁúÅ‰ªΩÂüéÂ∏ÇÊï∞ÊçÆ...')
    const data = await tagService.getProvincesWithCities()
    regionProvinces.value = data.provinces
    
    console.log('‚úÖ ÁúÅ‰ªΩÂüéÂ∏ÇÊï∞ÊçÆÂä†ËΩΩÊàêÂäü', {
      provinces: data.total_provinces,
      cities: data.total_cities,
      provincesData: regionProvinces.value.slice(0, 3)
    })
  } catch (error) {
    console.error('‚ùå Âä†ËΩΩÁúÅ‰ªΩÂüéÂ∏ÇÊï∞ÊçÆÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÁúÅ‰ªΩÂüéÂ∏ÇÊï∞ÊçÆÂ§±Ë¥•')
    
    // Êèê‰æõÂ§áÁî®Êï∞ÊçÆ
    regionProvinces.value = [
      {
        code: 'SC',
        name: 'ÂõõÂ∑ùÁúÅ',
        cities: ['ÊàêÈÉΩ', 'ÁªµÈò≥', 'Âæ∑Èò≥', 'ÂçóÂÖÖ', 'ÂÆúÂÆæ'],
        city_count: 5
      },
      {
        code: 'AH', 
        name: 'ÂÆâÂæΩÁúÅ',
        cities: ['ÂêàËÇ•', 'ËäúÊπñ', 'ËöåÂü†', 'Ê∑ÆÂçó', 'È©¨ÈûçÂ±±'],
        city_count: 5
      }
    ]
    console.log('üîÑ ‰ΩøÁî®Â§áÁî®ÁúÅ‰ªΩÂüéÂ∏ÇÊï∞ÊçÆ')
  }
}

const handleRegionProvinceChange = (provinceCode: string) => {
  console.log('üèõÔ∏è ÁúÅ‰ªΩÈÄâÊã©ÂèòÂåñ:', provinceCode)
  
  // Ê∏ÖÁ©∫ÂüéÂ∏ÇÈÄâÊã©
  regionSelector.selectedCity = ''
  regionSelector.previewTags = []
  
  // Êõ¥Êñ∞ÂèØÈÄâÂüéÂ∏ÇÂàóË°®
  const selectedProvince = regionProvinces.value.find(p => p.code === provinceCode)
  if (selectedProvince) {
    regionSelector.availableCities = selectedProvince.cities || []
    console.log(`‚úÖ ÁúÅ‰ªΩÈÄâÊã©ÊàêÂäü: ${selectedProvince.name}, ${regionSelector.availableCities.length}‰∏™ÂüéÂ∏Ç`, regionSelector.availableCities)
  } else {
    regionSelector.availableCities = []
    console.log('‚ùå Êú™ÊâæÂà∞ÂØπÂ∫îÁúÅ‰ªΩÊï∞ÊçÆ')
  }
}

const handleRegionCityChange = async (cityValue: string) => {
  if (!cityValue) {
    regionSelector.previewTags = []
    return
  }
  
  try {
    // Ë∞ÉÁî®ÂêéÁ´ØAPIËé∑ÂèñÂüéÂ∏ÇÁöÑÂÆåÊï¥Âå∫Âüü‰ø°ÊÅØ
    const data = await tagService.getCitiesDetails()
    const citiesDetails = data.cities
    
    const cityDetail = citiesDetails.find(c => c.city === cityValue)
    if (cityDetail) {
      // ÁîüÊàêÈ¢ÑËßàÊ†áÁ≠æ
      regionSelector.previewTags = []
      
      // ÂüéÂ∏ÇÊ†áÁ≠æ
      regionSelector.previewTags.push({
        name: cityDetail.city,
        level: 'city',
        weight: 2.5
      })
      
      // ÁúÅ‰ªΩÊ†áÁ≠æ
      if (cityDetail.province) {
        regionSelector.previewTags.push({
          name: cityDetail.province,
          level: 'province',
          weight: 2.0
        })
      }
      
      // Âå∫ÂüüÊ†áÁ≠æ
      if (cityDetail.region) {
        regionSelector.previewTags.push({
          name: cityDetail.region,
          level: 'region',
          weight: 1.5
        })
      }
      
      console.log('üèôÔ∏è ÂüéÂ∏ÇÈÄâÊã©ÂÆåÊàê:', cityDetail)
      console.log('üìù È¢ÑËßàÊ†áÁ≠æ:', regionSelector.previewTags)
    }
  } catch (error) {
    console.error('‚ùå Ëé∑ÂèñÂüéÂ∏ÇËØ¶ÊÉÖÂ§±Ë¥•:', error)
    ElMessage.error('Ëé∑ÂèñÂüéÂ∏ÇËØ¶ÊÉÖÂ§±Ë¥•')
  }
}

const addRegionTags = async () => {
  if (!regionSelector.selectedCity || !regionSelector.previewTags.length) {
    ElMessage.warning('ËØ∑ÂÖàÈÄâÊã©ÂüéÂ∏Ç')
    return
  }
  
  try {
    let addedCount = 0
    
    // Ê∑ªÂä†È¢ÑËßà‰∏≠ÁöÑÊ†áÁ≠æ
    for (const previewTag of regionSelector.previewTags) {
      // Ê£ÄÊü•Ê†áÁ≠æÊòØÂê¶Â∑≤Â≠òÂú®
      const existingTag = tags.value.find(tag => 
        tag.category === 'region' && tag.name === previewTag.name
      )
      
      if (!existingTag) {
        tags.value.push({
          category: 'region',
          name: previewTag.name,
          weight: previewTag.weight,
          source: previewTag.level === 'city' ? 'preset' : 'region_auto',
          created_at: new Date().toISOString()
        })
        addedCount++
      }
    }
    
    if (addedCount > 0) {
      hasChanges.value = true
      ElMessage.success(`ÊàêÂäüÊ∑ªÂä†${addedCount}‰∏™Âú∞Âå∫Ê†áÁ≠æ`)
      
      // Ê∏ÖÁ©∫ÈÄâÊã©Âô®
      regionSelector.selectedProvince = ''
      regionSelector.selectedCity = ''
      regionSelector.availableCities = []
      regionSelector.previewTags = []
    } else {
      ElMessage.info('ÊâÄÈÄâÂú∞Âå∫Ê†áÁ≠æÂ∑≤Â≠òÂú®ÔºåÊó†ÈúÄÊ∑ªÂä†')
    }
    
  } catch (error) {
    console.error('‚ùå Ê∑ªÂä†Âú∞Âå∫Ê†áÁ≠æÂ§±Ë¥•:', error)
    ElMessage.error('Ê∑ªÂä†Âú∞Âå∫Ê†áÁ≠æÂ§±Ë¥•')
  }
}

// ÁõëÂê¨Ê†áÁ≠æÂèòÂåñ
watch(tags, () => {
  const currentTagsStr = JSON.stringify(tags.value)
  const originalTagsStr = JSON.stringify(originalTags.value)
  hasChanges.value = currentTagsStr !== originalTagsStr
}, { deep: true })

// Êî∂ËóèÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞
const loadFavorites = async () => {
  try {
    favoritesLoading.value = true
    error.value = ''
    
    const userId = userStore.currentUser?.demo_user_id || userStore.currentUser?.id
    if (!userId) {
      throw new Error('ËØ∑ÂÖàÁôªÂΩï')
    }
    
    console.log('üíñ Ëé∑ÂèñÁî®Êà∑Êî∂Ëóè - userId:', userId)
    const favoritesList = await favoritesAPI.getFavoritesList(50)
    const stats = await favoritesAPI.getUserBehaviorStats()
    
    favorites.value = favoritesList
    Object.assign(behaviorStats.value, stats)
    
    console.log('‚úÖ Êî∂ËóèÂä†ËΩΩÊàêÂäüÔºåÊï∞Èáè:', favorites.value.length)
    ElMessage.success(`ÊàêÂäüÂä†ËΩΩ${favorites.value.length}‰∏™Êî∂Ëóè`)
  } catch (err: any) {
    console.error('‚ùå Ëé∑ÂèñÊî∂ËóèÂ§±Ë¥•:', err)
    error.value = err.response?.data?.message || err.message || 'Ëé∑ÂèñÊî∂ËóèÂ§±Ë¥•'
    ElMessage.error(error.value)
  } finally {
    favoritesLoading.value = false
  }
}

const removeFavorite = async (item: FavoriteItem) => {
  const result = await ElMessageBox.confirm(
    `Á°ÆÂÆöË¶ÅÂèñÊ∂àÊî∂Ëóè"${item.title}"ÂêóÔºü`,
    'ÂèñÊ∂àÊî∂ËóèÁ°ÆËÆ§',
    {
      confirmButtonText: 'ÂèñÊ∂àÊî∂Ëóè',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    }
  ).catch(() => false)
  
  if (!result) return
  
  try {
    await favoritesAPI.removeFavorite(item.content_id)
    
    favorites.value = favorites.value.filter(i => i._id !== item._id)
    ElMessage.success(`Â∑≤ÂèñÊ∂àÊî∂ËóèÔºö${item.title}`)
  } catch (err: any) {
    console.error('‚ùå ÂèñÊ∂àÊî∂ËóèÂ§±Ë¥•:', err)
    error.value = err.response?.data?.message || err.message || 'ÂèñÊ∂àÊî∂ËóèÂ§±Ë¥•'
    ElMessage.error(error.value)
  }
}

const handleSearch = () => {
  // ÂÆûÁé∞ÊêúÁ¥¢ÈÄªËæë
  if (searchQuery.value.trim()) {
    performSearch()
  }
}

const handleSearchClear = () => {
  searchQuery.value = ''
  loadFavorites()
}

const performSearch = async () => {
  if (!searchQuery.value.trim()) {
    loadFavorites()
    return
  }
  
  try {
    favoritesLoading.value = true
    const results = await favoritesAPI.searchFavorites(searchQuery.value.trim(), 50)
    favorites.value = results
    ElMessage.success(`ÊêúÁ¥¢Âà∞${results.length}ÁØáÊñáÁ´†`)
  } catch (err: any) {
    console.error('‚ùå ÊêúÁ¥¢Â§±Ë¥•:', err)
    ElMessage.error('ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑ÈáçËØï')
  } finally {
    favoritesLoading.value = false
  }
}

const resetAllFilters = () => {
  searchQuery.value = ''
  filters.contentType = ''
  filters.energyType = ''
  filters.region = ''
  filters.timeRange = ''
  filters.userTags = []
  loadFavorites()
}

const getContentTypeColor = (type: string) => {
  switch (type) {
    case 'policy': return 'success'
    case 'news': return 'primary'
    case 'price': return 'warning'
    case 'announcement': return 'danger'
    default: return 'info'
  }
}

const getContentTypeBarColor = (type: string) => {
  switch (type) {
    case 'policy': return '#67c23a'
    case 'news': return '#409eff'
    case 'price': return '#e6a23c'
    case 'announcement': return '#f56c6c'
    default: return '#909399'
  }
}

const getContentTypeLabel = (type: string) => {
  switch (type) {
    case 'policy': return 'ÊîøÁ≠ñ'
    case 'news': return 'ËµÑËÆØ'
    case 'price': return 'Ë∞É‰ª∑'
    case 'announcement': return 'ÂÖ¨Âëä'
    default: return 'ÂÖ∂‰ªñ'
  }
}

const getAllTagsFromFavorite = (item: FavoriteItem): string[] => {
  return [
    ...(item.energy_type_tags || []),
    ...(item.region_tags || [])
  ]
}

const getTagColor = (tag: string) => {
  if (tag.includes('Â§©ÁÑ∂Ê∞î') || tag.includes('ÂéüÊ≤π')) return 'warning'
  if (tag.includes('ÊîøÁ≠ñ') || tag.includes('Ê≥ïËßÑ')) return 'success'
  if (tag.includes('ÂÖ¨Âëä') || tag.includes('Ë∞É‰ª∑')) return 'danger'
  return 'info'
}

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('zh-CN')
}

// Á≠õÈÄâÂäüËÉΩÁõ∏ÂÖ≥ÂáΩÊï∞
const toggleAdvancedFilters = () => {
  showAdvancedFilters.value = !showAdvancedFilters.value
}

const applyFilters = () => {
  // Á≠õÈÄâÈÄªËæëÂ∑≤Âú® filteredFavorites ËÆ°ÁÆóÂ±ûÊÄß‰∏≠ÂÆûÁé∞
  // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†È¢ùÂ§ñÁöÑÈÄªËæëÔºåÊØîÂ¶ÇËÆ∞ÂΩïÁ≠õÈÄâË°å‰∏∫
  console.log('üîç Â∫îÁî®Á≠õÈÄâÊù°‰ª∂:', {
    contentType: filters.contentType,
    energyType: filters.energyType,
    region: filters.region,
    timeRange: filters.timeRange,
    userTags: filters.userTags,
    resultCount: filteredFavorites.value.length
  })
}

const toggleUserTagFilter = (tagName: string) => {
  const index = filters.userTags.indexOf(tagName)
  if (index > -1) {
    filters.userTags.splice(index, 1)
  } else {
    filters.userTags.push(tagName)
  }
  applyFilters()
}

const getTimeRangeLabel = (timeRange: string) => {
  switch (timeRange) {
    case '7days': return 'ÊúÄËøë7Â§©'
    case '30days': return 'ÊúÄËøë30Â§©'
    case '3months': return 'ÊúÄËøë3‰∏™Êúà'
    case '6months': return 'ÊúÄËøë6‰∏™Êúà'
    case '1year': return 'ÊúÄËøë1Âπ¥'
    default: return 'ÂÖ®ÈÉ®Êó∂Èó¥'
  }
}
</script>

<style scoped>
.dashboard-container {
  min-height: 100vh;
  max-width: 1280px;
  margin: 0 auto;
}

/* È°µÈù¢Â§¥ÈÉ® */
.header-section {
  text-align: center;
  margin-bottom: 32px;
  padding: 32px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.page-title {
  font-size: 32px;
  font-weight: bold;
  color: #1769aa;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
}

.title-icon {
  font-size: 36px;
  color: #1890ff;
}

.page-subtitle {
  font-size: 16px;
  color: #666;
  margin: 0;
}

/* ËÆæÁΩÆÂç°Áâá */
.settings-card {
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  margin-bottom: 24px;
}

.settings-tabs {
  border: none;
}

.settings-content {
  padding: 0;
}

/* Âä†ËΩΩÂíåÈîôËØØÁä∂ÊÄÅ */
.loading-container {
  padding: 40px;
}

.error-alert {
  margin-bottom: 24px;
}

/* ÁªüËÆ°Âç°Áâá */
.stats-section {
  margin-bottom: 24px;
}

.stat-card {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s;
  cursor: pointer;
  background: white;
  border: 1px solid #ebeef5;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stat-icon {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 32px;
  opacity: 0.3;
  color: #909399;
}

/* Ê†áÁ≠æÈ¢ÑËßàÂç°Áâá */
.preview-card {
  margin-bottom: 24px;
  border-radius: 12px;
  border: none;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0;
}

.preview-title {
  font-size: 18px;
  font-weight: bold;
  color: #303133;
}

.action-buttons {
  display: flex;
  gap: 12px;
}

.action-buttons .el-button {
  border-radius: 8px;
}

.preview-content {
  padding: 16px 0;
}

.all-tags-cloud {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

.preview-tag {
  margin: 0;
  border-radius: 6px;
  font-weight: 500;
  transition: all 0.3s;
  height: 32px;
  line-height: 32px;
  padding: 0 12px;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  box-sizing: border-box;
}

.preview-tag:hover {
  transform: scale(1.05);
}

/* Ê†áÁ≠æÁÆ°ÁêÜÂç°Áâá */
.tags-card {
  border-radius: 12px;
  border: none;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.tags-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0;
}

.tags-title {
  font-size: 18px;
  font-weight: bold;
  color: #303133;
}

.tags-tabs {
  border: none;
}

.tab-label {
  display: flex;
  align-items: center;
  gap: 8px;
}

.tab-content {
  padding: 20px 0;
}

/* ÂàÜÁ±ªÊèèËø∞ */
.category-description {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 16px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border-radius: 8px;
  margin-bottom: 24px;
  border: 1px solid #e2e8f0;
  color: #64748b;
  font-size: 14px;
}

.desc-icon {
  color: #3b82f6;
  font-size: 16px;
}

/* ÂΩìÂâçÊ†áÁ≠æÈÉ®ÂàÜ */
.current-tags-section {
  margin-bottom: 32px;
}

.section-title {
  font-size: 16px;
  font-weight: bold;
  color: #303133;
  margin: 0 0 16px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.tags-container {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: flex-start;
}

.tag-item-wrapper {
  position: relative;
}

/* Êñ∞ÁöÑÊ†áÁ≠æÊòæÁ§∫ÂåÖË£ÖÂô® */
.tag-display-wrapper {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: white;
  border-radius: 8px;
  padding: 4px;
  border: 2px solid transparent;
  transition: all 0.3s;
}

.tag-display-wrapper:hover {
  border-color: #409eff;
  box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
  transform: translateY(-2px);
}

.tag-item-display {
  margin: 0;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s;
  border: none !important;
}

.tag-item-display:hover {
  transform: scale(1.02);
}

.tag-content {
  display: flex;
  align-items: center;
  gap: 6px;
}

.tag-name {
  font-weight: 500;
}

.tag-weight {
  font-size: 12px;
  font-weight: bold;
  opacity: 0.8;
}

/* Ê†áÁ≠æÊìç‰ΩúÊåâÈíÆ */
.tag-actions {
  display: flex;
  align-items: center;
  gap: 4px;
}

.edit-icon,
.delete-icon {
  width: 16px;
  height: 16px;
  padding: 2px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 12px;
}

.edit-icon {
  color: #409eff;
  background: rgba(64, 158, 255, 0.1);
}

.edit-icon:hover {
  background: rgba(64, 158, 255, 0.2);
  transform: scale(1.1);
}

.delete-icon {
  color: #f56c6c;
  background: rgba(245, 108, 108, 0.1);
}

.delete-icon:hover {
  background: rgba(245, 108, 108, 0.2);
  transform: scale(1.1);
}

/* ÊùÉÈáçÁºñËæëÂô® */
.tag-weight-editor {
  display: inline-flex;
  align-items: center;
  background: white;
  border: 2px solid #409eff;
  border-radius: 6px;
  padding: 8px 12px;
  box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
}

.editor-content {
  display: flex;
  align-items: center;
  gap: 8px;
}

.editing-tag-name {
  font-weight: 500;
  color: #303133;
  white-space: nowrap;
}

.weight-editor-input {
  width: 80px;
}

.weight-editor-actions {
  display: flex;
  gap: 4px;
  margin-left: 8px;
}

.weight-editor-actions .el-button {
  padding: 4px 8px;
  border-radius: 4px;
}

/* Á©∫Ê†áÁ≠æÁä∂ÊÄÅ */
.empty-tags {
  text-align: center;
  padding: 32px;
  color: #909399;
  background: #fafafa;
  border-radius: 8px;
  border: 2px dashed #dcdfe6;
}

.empty-tags p {
  margin: 0;
  font-size: 14px;
}

/* È¢ÑËÆæÊ†áÁ≠æÈÉ®ÂàÜ */
.preset-tags-section {
  border-top: 1px solid #ebeef5;
  padding-top: 24px;
}

.preset-actions {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
}

.preset-hint {
  color: #909399;
  font-weight: normal;
}

.preset-tags-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

.preset-tag-item {
  margin: 0;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s;
  border: 2px solid transparent;
  display: flex;
  align-items: center;
  gap: 4px;
}

.preset-tag-item:hover {
  border-color: currentColor;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.preset-tag-item .el-icon {
  font-size: 12px;
}

/* ÂÜÖÂÆπÂç°Áâá */
.content-card {
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  text-align: center;
  padding: 40px;
}

.content-card h3 {
  margin: 0 0 16px 0;
  color: #303133;
}

.content-card p {
  margin: 0;
  color: #666;
}

/* Âú∞ÂüüÈÄâÊã©Âô®Ê†∑Âºè */
.region-selector-section {
  margin-bottom: 32px;
  padding: 20px;
  background: #f0f9ff;
  border: 2px dashed #3b82f6;
  border-radius: 12px;
}

.selector-hint {
  display: flex;
  align-items: center;
  gap: 8px;
}

.selector-hint-text {
  font-size: 12px;
  color: #3b82f6;
  font-weight: normal;
}

.region-selector-container {
  margin-top: 16px;
}

.region-selector-row {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 16px;
}

.province-selector {
  flex: 1;
  min-width: 160px;
}

.city-selector {
  flex: 1;
  min-width: 160px;
}

.region-preview {
  padding: 12px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.preview-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
}

.preview-tags .el-tag {
  margin: 0;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
  .dashboard-container {
    max-width: 1024px;
  }
}

@media (max-width: 768px) {
  .dashboard-container {
    max-width: 100%;
    margin: 0 16px;
  }
  
  .page-title {
    font-size: 28px;
  }
  
  .title-icon {
    font-size: 32px;
  }
  
  .stats-section .el-col {
    margin-bottom: 16px;
  }
  
  .action-buttons {
    flex-direction: column;
    gap: 8px;
  }
  
  .action-buttons .el-button {
    width: 100%;
  }
  
  .tags-container {
    gap: 8px;
  }
  
  .preset-tags-container {
    gap: 6px;
  }
  
  .editor-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .weight-editor-actions {
    margin-left: 0;
    margin-top: 8px;
  }
}

/* È°µÈù¢ÂÆΩÂ∫¶Âç†‰ΩçÁ¨¶ */
.width-placeholder {
  width: 1280px;
  min-width: 1280px;
  height: 1px;
  visibility: hidden;
  pointer-events: none;
  position: relative;
  margin: 0 auto;
}

/* Êî∂ËóèÁÆ°ÁêÜÊ†∑Âºè */
.search-card {
  margin-bottom: 24px;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  background: white;
}

.search-stats {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  height: 100%;
}

.search-result-text {
  font-size: 14px;
  color: #606266;
}

.search-result-text strong {
  color: #1890ff;
  font-weight: bold;
}

.favorites-card {
  border-radius: 12px;
  background: white;
  border: none;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  margin-bottom: 24px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  padding: 0;
}

.card-title {
  font-size: 18px;
  font-weight: bold;
  color: #303133;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  margin: 0;
}

.favorites-list {
  min-height: 400px;
}

.favorite-items {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.favorite-item {
  cursor: pointer;
  transition: all 0.3s;
  border-radius: 8px;
  background: white;
  border: 1px solid #ebeef5;
  overflow: hidden;
}

.favorite-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.favorite-item-body {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 20px;
  gap: 16px;
}

.favorite-main {
  flex: 1;
}

.favorite-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.content-type-tag {
  font-weight: bold;
  border-radius: 6px;
}

.favorite-source {
  font-size: 12px;
  color: #909399;
}

.favorite-date {
  font-size: 12px;
  color: #909399;
}

.favorite-title {
  margin: 0 0 8px 0;
  font-size: 16px;
  font-weight: bold;
  color: #303133;
  line-height: 1.4;
}

.article-link {
  color: #409eff;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.article-link:hover {
  color: #66b1ff;
}

.external-link-icon {
  font-size: 12px;
}

.favorite-publish-date {
  margin: 0 0 12px 0;
  font-size: 12px;
  color: #909399;
}

.favorite-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}

.favorite-tag {
  margin: 0;
  border-radius: 4px;
}

.more-tags {
  font-size: 12px;
  color: #909399;
  background: #f5f7fa;
  padding: 2px 6px;
  border-radius: 4px;
}

.favorite-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
}

/* Element Plus Ê†∑ÂºèÈáçÂÜô */
:deep(.el-statistic__head) {
  color: #606266;
  margin-bottom: 8px;
}

:deep(.el-statistic__content) {
  color: #303133;
  font-weight: bold;
}

:deep(.el-tabs__header) {
  margin: 0 0 20px 0;
}

:deep(.el-tabs__nav-wrap::after) {
  display: none;
}

:deep(.el-tabs__item) {
  padding: 0 20px;
  font-weight: 500;
}

:deep(.el-tabs__item.is-active) {
  color: #409eff;
  font-weight: bold;
}

:deep(.el-badge__content) {
  border: none;
  font-weight: bold;
  font-size: 10px;
  padding: 0 4px;
  min-width: 16px;
  height: 16px;
  line-height: 16px;
}

/* Êî∂ËóèÁªüËÆ°ÂàÜÊûêÊ†∑Âºè */
.stats-analysis-card {
  border-radius: 12px;
  background: white;
  border: none;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  margin-bottom: 24px;
}

.stats-section-item {
  padding: 16px;
  background: #fafbfc;
  border-radius: 8px;
  border: 1px solid #ebeef5;
}

.stats-section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: bold;
  color: #303133;
  margin: 0 0 16px 0;
}

.stats-chart {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.stats-bar-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.stats-bar-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
}

.stats-count {
  color: #606266;
  font-weight: 500;
}

.stats-bar {
  height: 8px;
  background: #f5f7fa;
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.stats-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.stats-percentage {
  font-size: 11px;
  color: #909399;
  text-align: right;
}

.trend-stats {
  margin-top: 16px;
}

.trend-item {
  text-align: center;
  padding: 16px;
  background: white;
  border-radius: 8px;
  border: 1px solid #ebeef5;
  transition: all 0.3s;
}

.trend-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.trend-value {
  font-size: 24px;
  font-weight: bold;
  color: #409eff;
  margin-bottom: 8px;
}

.trend-label {
  font-size: 12px;
  color: #606266;
}

/* È´òÁ∫ßÁ≠õÈÄâÊ†∑Âºè */
.search-row {
  margin-bottom: 0;
}

.advanced-filters {
  margin-top: 20px;
  padding-top: 20px;
}

.filter-row {
  margin-bottom: 16px;
}

.filter-group {
  margin-bottom: 16px;
}

.filter-label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
  font-weight: 500;
  color: #303133;
  margin-bottom: 8px;
}

.my-tags-filter {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
  min-height: 60px;
}

.user-tag-filter {
  cursor: pointer;
  transition: all 0.3s;
  margin: 0;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.user-tag-filter:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.user-tag-filter .tag-weight {
  font-size: 11px;
  opacity: 0.7;
  margin-left: 2px;
}

.filter-summary {
  margin-top: 16px;
}

.active-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
}

.active-filters .el-tag {
  margin: 0;
}
</style> 