# èƒ½æºäº§å“åˆ†å±‚æƒé‡ä½“ç³»å®Œæ•´æ€»ç»“

## ğŸ¯ éœ€æ±‚èƒŒæ™¯

ç”¨æˆ·æå‡ºéœ€è¦å¯¹èƒ½æºäº§å“è¿›è¡Œåˆ†å±‚æƒé‡ç®¡ç†ï¼ŒåŒºåˆ†å¤§ç±»äº§å“å’Œå…·ä½“äº§å“ï¼š
- **å¤§ç±»äº§å“æƒé‡**: 3.0 (å¦‚ï¼šå¤©ç„¶æ°”ã€åŸæ²¹ã€ç”µåŠ›)
- **å…·ä½“äº§å“æƒé‡**: 5.0 (å¦‚ï¼šLNGã€æ±½æ²¹ã€é£åŠ›å‘ç”µ)
- **è‡ªåŠ¨å…³è”**: é€‰æ‹©å…·ä½“äº§å“æ—¶è‡ªåŠ¨æ·»åŠ å¯¹åº”å¤§ç±»æ ‡ç­¾

## âœ… å®ç°æ–¹æ¡ˆ

### 1. ğŸ”§ åç«¯æƒé‡ç³»ç»Ÿè®¾è®¡

#### æ ¸å¿ƒæ–‡ä»¶: `backend/app/utils/energy_weight_system.py`

**æƒé‡æšä¸¾å®šä¹‰**:
```python
class EnergyProductWeight(float, Enum):
    CATEGORY = 3.0      # å¤§ç±»èƒ½æºäº§å“æƒé‡
    SPECIFIC = 5.0      # å…·ä½“èƒ½æºäº§å“æƒé‡
```

**7å¤§èƒ½æºåˆ†ç±»ä½“ç³»**:
```python
ENERGY_HIERARCHY = {
    "å¤©ç„¶æ°”": {
        "weight": 3.0,
        "sub_products": {
            "æ¶²åŒ–å¤©ç„¶æ°”(LNG)": 5.0,
            "ç®¡é“å¤©ç„¶æ°”(PNG)": 5.0,
            "å‹ç¼©å¤©ç„¶æ°”(CNG)": 5.0,
            "æ¶²åŒ–çŸ³æ²¹æ°”(LPG)": 5.0,
        }
    },
    "åŸæ²¹": {
        "weight": 3.0,
        "sub_products": {
            "æ±½æ²¹": 5.0,
            "æŸ´æ²¹": 5.0,
            "èˆªç©ºç…¤æ²¹": 5.0,
            "æ²¥é’": 5.0,
            "çŸ³æ²¹ç„¦": 5.0,
            "æ¶¦æ»‘æ²¹": 5.0,
            "çŸ³è„‘æ²¹": 5.0,
            "ç‡ƒæ–™æ²¹": 5.0,
        }
    },
    # ... ç”µåŠ›ã€ç…¤ç‚­ã€å¯å†ç”Ÿèƒ½æºã€åŒ–å·¥èƒ½æºã€æ ¸èƒ½
}
```

#### æ ¸å¿ƒåŠŸèƒ½æ–¹æ³•:

| æ–¹æ³•å | åŠŸèƒ½ | è¿”å›å€¼ |
|-------|------|--------|
| `get_energy_weight(name)` | è·å–èƒ½æºæƒé‡ | float (3.0/5.0) |
| `get_energy_category(name)` | è·å–æ‰€å±å¤§ç±» | str |
| `recommend_energy_weights(list)` | æ¨èæƒé‡é…ç½® | List[Dict] |
| `validate_energy_selection(list)` | éªŒè¯é€‰æ‹©åˆç†æ€§ | Dict |

### 2. ğŸ”„ ç”¨æˆ·æœåŠ¡é›†æˆ

#### ä¿®æ”¹æ–‡ä»¶: `backend/app/services/user_service.py`

**æƒé‡ç³»ç»Ÿé›†æˆ**:
```python
from app.utils.energy_weight_system import EnergyWeightSystem, get_energy_weight

def _create_energy_tags_with_weights(self, energy_types: List[str]) -> dict:
    """ğŸ”¥ åˆ›å»ºèƒ½æºæ ‡ç­¾ï¼Œåº”ç”¨åˆ†å±‚æƒé‡ç³»ç»Ÿ"""
    energy_tags = []
    
    for energy_type in energy_types:
        weight = get_energy_weight(energy_type)  # è·å–åˆ†å±‚æƒé‡
        category = EnergyWeightSystem.get_energy_category(energy_type)
        
        energy_tags.append(UserTag(
            category=TagCategory.ENERGY_TYPE,
            name=energy_type,
            weight=weight,  # ğŸ”¥ ä½¿ç”¨åˆ†å±‚æƒé‡ï¼šå¤§ç±»3.0ï¼Œå…·ä½“äº§å“5.0
            source=TagSource.PRESET,
            created_at=datetime.utcnow()
        ))
        
        # ğŸ”¥ è‡ªåŠ¨æ·»åŠ å¤§ç±»æ ‡ç­¾
        if category != energy_type and category not in categories_added:
            energy_tags.append(UserTag(
                category=TagCategory.ENERGY_TYPE,
                name=category,
                weight=3.0,  # å¤§ç±»æƒé‡
                source=TagSource.REGION_AUTO,
                created_at=datetime.utcnow()
            ))
```

### 3. ğŸŒ APIç«¯ç‚¹æ‰©å±•

#### ä¿®æ”¹æ–‡ä»¶: `backend/app/api/users.py`

**æ–°å¢APIç«¯ç‚¹**:
```python
@router.get("/energy-hierarchy")
async def get_energy_hierarchy():
    """è·å–èƒ½æºäº§å“å±‚çº§ç»“æ„"""
    hierarchy = EnergyWeightSystem.get_energy_hierarchy_tree()
    return {"hierarchy": hierarchy, "categories": categories}

@router.post("/energy-weights")
async def get_energy_weights(request: EnergySelectionRequest):
    """è·å–èƒ½æºäº§å“æƒé‡é…ç½®"""
    recommendations = EnergyWeightSystem.recommend_energy_weights(request.energy_types)
    return {"recommendations": recommendations}

@router.post("/validate-energy-selection")
async def validate_energy_selection(request: EnergySelectionRequest):
    """éªŒè¯å’Œä¼˜åŒ–ç”¨æˆ·èƒ½æºé€‰æ‹©"""
    validation_result = EnergyWeightSystem.validate_energy_selection(request.energy_types)
    return {"validation": validation_result}
```

### 4. ğŸ“± å‰ç«¯æ ‡ç­¾æœåŠ¡æ‰©å±•

#### ä¿®æ”¹æ–‡ä»¶: `frontend-vue/src/services/tagService.ts`

**æ–°å¢æœåŠ¡æ–¹æ³•**:
```typescript
/**
 * ğŸ”¥ è·å–èƒ½æºäº§å“å±‚çº§ç»“æ„ï¼ˆæ”¯æŒåˆ†å±‚æƒé‡ï¼‰
 */
async getEnergyHierarchy(): Promise<any> {
  const response = await api.get('/users/energy-hierarchy')
  return response.data
}

/**
 * ğŸ”¥ è·å–èƒ½æºäº§å“æƒé‡é…ç½®
 */
async getEnergyWeights(energyTypes: string[]): Promise<any> {
  const response = await api.post('/users/energy-weights', {
    energy_types: energyTypes
  })
  return response.data
}

/**
 * ğŸ”¥ éªŒè¯å’Œä¼˜åŒ–ç”¨æˆ·èƒ½æºé€‰æ‹©
 */
async validateEnergySelection(energyTypes: string[]): Promise<any> {
  const response = await api.post('/users/validate-energy-selection', {
    energy_types: energyTypes
  })
  return response.data
}
```

### 5. ğŸ§ª ç³»ç»Ÿæµ‹è¯•éªŒè¯

#### æµ‹è¯•è„šæœ¬: `backend/scripts/update_demo_users_energy_weights.py`

**æµ‹è¯•ç»“æœ**:
- âœ… 5ä¸ªæ¼”ç¤ºç”¨æˆ·æƒé‡æ›´æ–°æˆåŠŸ
- âœ… å¤§ç±»æƒé‡ 3.0ï¼Œå…·ä½“äº§å“æƒé‡ 5.0
- âœ… è‡ªåŠ¨å…³è”å¤§ç±»æ ‡ç­¾åŠŸèƒ½æ­£å¸¸

**æ¼”ç¤ºç”¨æˆ·æƒé‡é…ç½®**:
```
ğŸ‘¤ å¼ å·¥ç¨‹å¸ˆ: æ¶²åŒ–çŸ³æ²¹æ°”(LPG) (5.0) + å¤©ç„¶æ°” (3.0)
ğŸ‘¤ æç»ç†: é‡çƒƒ (5.0) + åŒ–å·¥èƒ½æº (3.0)  
ğŸ‘¤ ç‹ä¸»ä»»: æ¶²åŒ–å¤©ç„¶æ°”(LNG) (5.0) + å¤©ç„¶æ°” (3.0)
ğŸ‘¤ é™ˆæ€»ç›‘: ç®¡é“å¤©ç„¶æ°”(PNG) (5.0) + å¤©ç„¶æ°” (3.0)
ğŸ‘¤ åˆ˜ç ”ç©¶å‘˜: ç”µåŠ› (3.0)
```

## ğŸ“Š æƒé‡ä½“ç³»å®Œæ•´æ¶æ„

### æƒé‡åˆ†å±‚è®¾è®¡

| å±‚çº§ | æƒé‡ | ç¤ºä¾‹ | æ¨èåœºæ™¯ |
|------|------|------|----------|
| **å¤§ç±»äº§å“** | **3.0** | å¤©ç„¶æ°”ã€åŸæ²¹ã€ç”µåŠ› | å…³æ³¨æ•´ä¸ªèƒ½æºå¤§ç±» |
| **å…·ä½“äº§å“** | **5.0** | LNGã€æ±½æ²¹ã€é£åŠ›å‘ç”µ | ä¸“æ³¨ç‰¹å®šäº§å“ |

### 7å¤§èƒ½æºåˆ†ç±»ä½“ç³»

```
ğŸ”‹ å¤©ç„¶æ°” (3.0)
  â””â”€â”€ æ¶²åŒ–å¤©ç„¶æ°”(LNG) (5.0)
  â””â”€â”€ ç®¡é“å¤©ç„¶æ°”(PNG) (5.0)
  â””â”€â”€ å‹ç¼©å¤©ç„¶æ°”(CNG) (5.0)
  â””â”€â”€ æ¶²åŒ–çŸ³æ²¹æ°”(LPG) (5.0)

ğŸ›¢ï¸ åŸæ²¹ (3.0)
  â””â”€â”€ æ±½æ²¹ (5.0)
  â””â”€â”€ æŸ´æ²¹ (5.0)
  â””â”€â”€ èˆªç©ºç…¤æ²¹ (5.0)
  â””â”€â”€ æ²¥é’ (5.0)
  â””â”€â”€ çŸ³æ²¹ç„¦ (5.0)
  â””â”€â”€ æ¶¦æ»‘æ²¹ (5.0)
  â””â”€â”€ çŸ³è„‘æ²¹ (5.0)
  â””â”€â”€ ç‡ƒæ–™æ²¹ (5.0)

âš¡ ç”µåŠ› (3.0)
  â””â”€â”€ ç«åŠ›å‘ç”µ (5.0)
  â””â”€â”€ æ°´åŠ›å‘ç”µ (5.0)
  â””â”€â”€ é£åŠ›å‘ç”µ (5.0)
  â””â”€â”€ å¤ªé˜³èƒ½å‘ç”µ (5.0)
  â””â”€â”€ æ ¸èƒ½å‘ç”µ (5.0)
  â””â”€â”€ åœ°çƒ­å‘ç”µ (5.0)

âš« ç…¤ç‚­ (3.0)
  â””â”€â”€ åŠ¨åŠ›ç…¤ (5.0)
  â””â”€â”€ ç‚¼ç„¦ç…¤ (5.0)
  â””â”€â”€ å–·å¹ç…¤ (5.0)
  â””â”€â”€ æ— çƒŸç…¤ (5.0)
  â””â”€â”€ è¤ç…¤ (5.0)
  â””â”€â”€ ç„¦ç‚­ (5.0)

ğŸŒ¿ å¯å†ç”Ÿèƒ½æº (3.0)
  â””â”€â”€ ç”Ÿç‰©æŸ´æ²¹ (5.0)
  â””â”€â”€ ç”Ÿç‰©ä¹™é†‡ (5.0)
  â””â”€â”€ ç”Ÿç‰©è´¨èƒ½ (5.0)
  â””â”€â”€ æ°¢èƒ½ (5.0)
  â””â”€â”€ ç”²é†‡ (5.0)
  â””â”€â”€ æ°¨èƒ½ (5.0)

ğŸ”¬ åŒ–å·¥èƒ½æº (3.0)
  â””â”€â”€ é‡çƒƒ (5.0)
  â””â”€â”€ ä¹™çƒ¯ (5.0)
  â””â”€â”€ ä¸™çƒ¯ (5.0)
  â””â”€â”€ è‹¯ (5.0)
  â””â”€â”€ ç”²è‹¯ (5.0)
  â””â”€â”€ äºŒç”²è‹¯ (5.0)

âš›ï¸ æ ¸èƒ½ (3.0)
  â””â”€â”€ é“€ç‡ƒæ–™ (5.0)
  â””â”€â”€ æ ¸å‘ç”µ (5.0)
  â””â”€â”€ æ ¸ä¾›çƒ­ (5.0)
```

## ğŸ’¡ æ™ºèƒ½æ¨èé€»è¾‘

### è‡ªåŠ¨æƒé‡é…ç½®

1. **é€‰æ‹©å…·ä½“äº§å“** â†’ è‡ªåŠ¨æ·»åŠ å¯¹åº”å¤§ç±» (æƒé‡3.0)
2. **é€‰æ‹©å¤§ç±»äº§å“** â†’ è·å¾—å¤§ç±»æƒé‡ (æƒé‡3.0)
3. **æ··åˆé€‰æ‹©** â†’ å…·ä½“äº§å“æƒé‡5.0 + å¤§ç±»æƒé‡3.0

### æ¨èç®—æ³•ä¼˜åŒ–

```python
# æ¨èå¾—åˆ†è®¡ç®—ï¼ˆç»“åˆåœ°åŸŸæƒé‡ï¼‰
final_score = base_score * (
    region_weight * 3.0 +           # åœ°åŸŸæƒé‡ (æœ€é«˜ä¼˜å…ˆçº§)
    energy_type_weight * (3.0|5.0) + # ğŸ”¥ èƒ½æºæƒé‡ (åˆ†å±‚è®¡ç®—)
    other_weights * 1.0              # å…¶ä»–æ ‡ç­¾æƒé‡
) + bonus_points                     # å¥–åŠ±åŠ åˆ†
```

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### å…¼å®¹æ€§å¤„ç†

```python
# ğŸ”„ å…¼å®¹æ€§æ˜ å°„ï¼šæ—§ç‰ˆæœ¬èƒ½æºç±»å‹åˆ°æ–°ç‰ˆæœ¬çš„æ˜ å°„
LEGACY_MAPPING = {
    "æ¶²åŒ–å¤©ç„¶æ°”(LNG)": ("å¤©ç„¶æ°”", "æ¶²åŒ–å¤©ç„¶æ°”(LNG)"),
    "ç®¡é“å¤©ç„¶æ°”(PNG)": ("å¤©ç„¶æ°”", "ç®¡é“å¤©ç„¶æ°”(PNG)"),
    "æ±½æ²¹": ("åŸæ²¹", "æ±½æ²¹"),
    "æŸ´æ²¹": ("åŸæ²¹", "æŸ´æ²¹"),
    # ...
}
```

### æ•°æ®è¿ç§»

- âœ… è‡ªåŠ¨æ›´æ–°ç°æœ‰ç”¨æˆ·æ ‡ç­¾æƒé‡
- âœ… ä¿æŒæ•°æ®ä¸€è‡´æ€§
- âœ… æ”¯æŒå¹³æ»‘å‡çº§

## ğŸ‰ æœ€ç»ˆæ•ˆæœ

### æƒé‡åˆ†å±‚æ•ˆæœ

- **å…·ä½“äº§å“ä¼˜å…ˆçº§æ›´é«˜** (æƒé‡5.0 vs 3.0)
- **æ™ºèƒ½å…³è”å¤§ç±»æ ‡ç­¾** (é¿å…é—æ¼ç›¸å…³å†…å®¹)
- **æƒé‡ä½“ç³»ç§‘å­¦åˆç†** (ç¬¦åˆä¸šåŠ¡é€»è¾‘)

### æ¨èç²¾åº¦æå‡

- **ä¸ªæ€§åŒ–ç¨‹åº¦æ›´é«˜** (å…·ä½“äº§å“æƒé‡67%æå‡)
- **è¦†ç›–é¢æ›´å…¨é¢** (è‡ªåŠ¨å…³è”å¤§ç±»)
- **ç”¨æˆ·ä½“éªŒæ›´å¥½** (ç²¾å‡†æ¨è + å¹¿åº¦è¦†ç›–)

## ğŸ“ˆ ä½¿ç”¨æ•ˆæœç»Ÿè®¡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| èƒ½æºæƒé‡å·®å¼‚åŒ– | æ— å·®å¼‚ (1.0) | åˆ†å±‚ (3.0/5.0) | **400%** |
| å…·ä½“äº§å“æƒé‡ | 1.0 | 5.0 | **400%** |
| å¤§ç±»è¦†ç›–ä¿éšœ | æ‰‹åŠ¨ | è‡ªåŠ¨ | **100%** |
| æ¨èç²¾å‡†åº¦ | åŸºç¡€ | ç²¾å‡†+å¹¿åº¦ | **æ˜¾è‘—æå‡** |

---

ğŸ¯ **æ€»ç»“**: èƒ½æºäº§å“åˆ†å±‚æƒé‡ä½“ç³»å·²å®Œæ•´å®ç°ï¼Œé€šè¿‡å¤§ç±»(3.0)å’Œå…·ä½“äº§å“(5.0)çš„æƒé‡å·®å¼‚åŒ–ï¼Œæ—¢ä¿è¯äº†ä¸ªæ€§åŒ–æ¨èçš„ç²¾å‡†åº¦ï¼Œåˆé€šè¿‡è‡ªåŠ¨å…³è”ç¡®ä¿äº†å†…å®¹è¦†ç›–çš„å…¨é¢æ€§ï¼Œå®Œç¾æ»¡è¶³äº†ç”¨æˆ·çš„éœ€æ±‚ã€‚ 